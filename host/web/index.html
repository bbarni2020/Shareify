<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shareify</title>
    <link rel="stylesheet" href="web/index.css">
    <link rel="shortcut icon" href="web/assets/icon.ico" type="image/x-icon">
</head>
<body>
    <div class="container">
        <div class="app_icons" style="background: url(web/assets/finder.png) lightgray 50% / cover no-repeat;" onclick="finder_open()">
            <div class="indicator" id="finder-indicator"></div>
        </div>
        <div class="app_icons" style="background: url(web/assets/user.png) lightgray 50% / cover no-repeat;" onclick="users_open()">
            <div class="indicator" id="users-indicator"></div>
        </div>
        <div class="app_icons" style="background: url(web/assets/nas.png) lightgray 50% / cover no-repeat;" onclick="nas_open()">
            <div class="indicator" id="nas-indicator"></div>
        </div>
        <div class="app_icons" style="background: url(web/assets/settings.png) lightgray 50% / cover no-repeat;" onclick="settings_open()">
            <div class="indicator" id="settings-indicator"></div>
        </div>
    </div>
    <div class="clock_div">
        <div id="clock" class="clock_text"></div>
        <div class="clock_img"></div>
    </div>
    <div class="leave" id="leave"></div>
    <div class="window" id="finder-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Finder</div>
        <div class="resize_handle"></div>
    </div>
    <div class="window" id="users-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Users</div>
        <div class="resize_handle"></div>
    </div>
    <div class="window" id="nas-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">NAS</div>
        <div class="resize_handle"></div>
    </div>
    <div class="window" id="settings-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Settings</div>
        <div class="sections_container">
            <div class="section">
                <div class="section_title">
                    <p>Personal settings</p>
                    <div class="dropdown_icon"></div>
                </div>
                <div class="section_content">
                    <p style="font-size: 17px;">Here you can edit your personal settings.</p>
                    <div class="horizontal-align">
                        <label for="name">Preferred name:</label>
                        <input type="text" name="name" id="name" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="username">Username:</label>
                        <input type="text" name="username" id="username" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="password_web">Password:</label>
                        <input type="text" name="password_web" id="password_web" class="textbox">
                    </div>
                    <div class="horizontal-align" style="margin-top: 10px;">
                        <div style="width: 100%;"></div>
                        <div id="personal_saved" class="saved_text">Saved</div>
                        <div class="accept_btn" id="personal_accept"><img src="web/assets/pipe.png" alt="pipe" class="centered-img"></div>
                    </div>
                    <div class="horizontal-align" style="margin-top: 10px;">
                        <label for="icon-select">Icon (in background):</label>
                        <select id="icon-select">
                            <option>Visible</option>
                            <option>Hidden</option>
                        </select>
                    </div>
                    <div style="margin-top: 18px; margin-bottom: 8px; font-size: 17px;">Choose background:</div>
                    <div class="background-selector" id="background-selector">
                        <div class="background-thumb selected" data-bg="assets/backgrounds/back1.png" style="background-image: url('web/assets/backgrounds/back1.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back2.png" style="background-image: url('web/assets/backgrounds/back2.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back3.png" style="background-image: url('web/assets/backgrounds/back3.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back4.png" style="background-image: url('web/assets/backgrounds/back4.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back5.png" style="background-image: url('web/assets/backgrounds/back5.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back6.png" style="background-image: url('web/assets/backgrounds/back6.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back7.png" style="background-image: url('web/assets/backgrounds/back7.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back8.png" style="background-image: url('web/assets/backgrounds/back8.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back9.png" style="background-image: url('web/assets/backgrounds/back9.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back10.png" style="background-image: url('web/assets/backgrounds/back10.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back11.png" style="background-image: url('web/assets/backgrounds/back11.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back12.png" style="background-image: url('web/assets/backgrounds/back12.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back13.png" style="background-image: url('web/assets/backgrounds/back13.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back14.png" style="background-image: url('web/assets/backgrounds/back14.png');"></div>
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="section_title">
                    <p>Server settings</p>
                    <div class="dropdown_icon"></div>
                </div>
                <div class="section_content">
                    <p style="font-size: 17px;">Here you can edit the server's general settings.</p>
                    <div class="horizontal-align">
                        <label for="path">Default path:</label>
                        <input type="text" name="path" id="path" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="host">Host ip:</label>
                        <input type="text" name="host" id="host" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="port">Host port:</label>
                        <input type="number" name="port" id="port" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="ftp-server">FTP server:</label>
                        <select id="ftp-server">
                            <option>On</option>
                            <option>Off</option>
                        </select>
                    </div>
                    <div class="horizontal-align" style="margin-top: 10px;">
                        <div style="width: 100%;"></div>
                        <div id="server_saved" class="saved_text">Saved</div>
                        <div class="accept_btn" id="server_accept"><img src="web/assets/pipe.png" alt="pipe" class="centered-img"></div>
                    </div>
                    <div class="horizontal-align" style="margin-top: 25px;">
                        <label id="current_version">Current version: loading...</label>
                    </div>
                    <div id="version" style="margin-top: 5px;">
                        <div class="horizontal-align">
                            <h4 id="newest_version">Newest: loading...</h2>
                            <div style="width: 90%;"></div>
                            <h5>Update</h6>
                            <div class="update_btn" id="verison"><img src="web/assets/go.png" alt="Update" class="centered-img"></div>
                        </div>
                        <h5 id="version_description">Description: loading...</h3>
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="section_title">
                    <p>FTP settings</p>
                    <div class="dropdown_icon"></div>
                </div>
                <div class="section_content">
                    <p style="font-size: 17px;">Here you can edit the server's general settings.</p>
                    <div class="horizontal-align">
                        <label for="ftp-ip">FTP server ip:</label>
                        <input type="text" name="ftp-ip" id="ftp-ip" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="ftp-port">FTP server port:</label>
                        <input type="number" name="ftp-port" id="ftp-port" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="ftp-timeout">FTP timeout:</label>
                        <input type="number" name="ftp-timeout" id="ftp-timeout" class="textbox">
                    </div>
                    <div class="horizontal-align" style="margin-top: 10px;">
                        <div style="width: 100%;"></div>
                        <div id="ftp_saved" class="saved_text">Saved</div>
                        <div class="accept_btn" id="ftp_accept"><img src="web/assets/pipe.png" alt="pipe" class="centered-img"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="resize_handle"></div>
    </div>
    <div class="icon"></div>
</body>
<script>
    const windows = document.querySelectorAll('.window');
    let zIndexCounter = 1;
    let isDragging = false;
    let isResizing = false;
    let offsetX, offsetY, startWidth, startHeight;
    let activeDragWindow = null;

    function getTopmostWindow() {
        let topWindow = null;
        let topZ = -Infinity;
        windows.forEach(w => {
            const z = parseInt(w.style.zIndex) || 0;
            if (w.classList.contains('show') && z > topZ) {
                topZ = z;
                topWindow = w;
            }
        });
        return topWindow;
    }

    windows.forEach((windowElement) => {
        const exitButton = windowElement.querySelector('.exit_btn');
        const resizeHandle = windowElement.querySelector('.resize_handle');

        exitButton.addEventListener('click', () => {
            const windowId = windowElement.id;
            const indicatorId = `${windowId.split('-')[0]}-indicator`;
            windowElement.classList.add('hide');
            windowElement.classList.remove('show');
            updateIndicator(windowId, indicatorId);
        });

        windowElement.addEventListener('mousedown', (e) => {
            if (e.target === resizeHandle || e.target === exitButton) return;
            bringToFront(windowElement);
            if (getTopmostWindow() !== windowElement) return;
            isDragging = true;
            activeDragWindow = windowElement;
            offsetX = e.clientX - windowElement.offsetLeft;
            offsetY = e.clientY - windowElement.offsetTop;
            windowElement.style.cursor = 'grabbing';
        });

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            offsetX = e.clientX;
            offsetY = e.clientY;
            startWidth = windowElement.offsetWidth;
            startHeight = windowElement.offsetHeight;
            e.stopPropagation();
            bringToFront(windowElement);
        });
    });

    document.addEventListener('mousemove', (e) => {
        if (isDragging && activeDragWindow) {
            activeDragWindow.style.left = `${e.clientX - offsetX}px`;
            activeDragWindow.style.top = `${e.clientY - offsetY}px`;
        } else if (isResizing) {
            const activeWindow = document.querySelector('.window.show');
            if (activeWindow) {
                const newWidth = Math.max(startWidth + (e.clientX - offsetX), 300);
                const newHeight = Math.max(startHeight + (e.clientY - offsetY), 200);
                activeWindow.style.width = `${newWidth}px`;
                activeWindow.style.height = `${newHeight}px`;
            }
        }
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
        isResizing = false;
        activeDragWindow = null;
        document.body.style.cursor = 'default';
    });

    function bringToFront(windowElement) {
        zIndexCounter++;
        windowElement.style.zIndex = zIndexCounter;
    }

    function updateIndicator(windowId, indicatorId) {
        const windowElement = document.getElementById(windowId);
        const indicatorElement = document.getElementById(indicatorId);
        if (windowElement.classList.contains('show')) {
            indicatorElement.classList.add('active');
        } else {
            indicatorElement.classList.remove('active');
        }
    }

    function finder_open() {
        const windowElement = document.getElementById('finder-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            updateIndicator('finder-window', 'finder-indicator');
        }
    }

    function users_open() {
        const windowElement = document.getElementById('users-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            updateIndicator('users-window', 'users-indicator');
        }
    }

    function nas_open() {
        const windowElement = document.getElementById('nas-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            updateIndicator('nas-window', 'nas-indicator');
        }
    }

    function settings_open() {
        const windowElement = document.getElementById('settings-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            updateIndicator('settings-window', 'settings-indicator');
        }
    }

    document.querySelectorAll('.section_title').forEach((titleElement) => {
        titleElement.addEventListener('click', () => {
            const section = titleElement.parentElement;
            section.classList.toggle('expanded');
        });
    });

    document.querySelectorAll('.custom-dropdown').forEach(dropdown => {
        const selected = dropdown.querySelector('.dropdown-selected');
        const list = dropdown.querySelector('.dropdown-list');
        const options = dropdown.querySelectorAll('.dropdown-option');
        const selectedText = dropdown.querySelector('span');

        selected.addEventListener('click', (e) => {
            e.stopPropagation();
            document.querySelectorAll('.custom-dropdown.open').forEach(d => {
                if (d !== dropdown) d.classList.remove('open');
            });
            dropdown.classList.toggle('open');
        });

        options.forEach(option => {
            option.addEventListener('click', (e) => {
                options.forEach(o => o.classList.remove('active'));
                option.classList.add('active');
                selectedText.textContent = option.textContent;
                dropdown.classList.remove('open');
            });
        });

        document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        dropdown.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                dropdown.classList.toggle('open');
                e.preventDefault();
            }
            if (e.key === 'Escape') {
                dropdown.classList.remove('open');
            }
        });
    });

    document.documentElement.style.transition = "background-image 0.4s ease";

    let bgFadeOverlay = document.createElement('div');
    bgFadeOverlay.id = 'bg-fade-overlay';
    bgFadeOverlay.style.position = 'fixed';
    bgFadeOverlay.style.top = 0;
    bgFadeOverlay.style.left = 0;
    bgFadeOverlay.style.width = '100vw';
    bgFadeOverlay.style.height = '100vh';
    bgFadeOverlay.style.zIndex = '-1';
    bgFadeOverlay.style.pointerEvents = 'none';
    bgFadeOverlay.style.opacity = '0';
    bgFadeOverlay.style.transition = 'opacity 0.4s ease';
    bgFadeOverlay.style.backgroundSize = 'cover';
    bgFadeOverlay.style.backgroundPosition = 'center center';
    bgFadeOverlay.style.backgroundRepeat = 'no-repeat';
    document.body.prepend(bgFadeOverlay);

    document.querySelectorAll('.background-thumb').forEach(thumb => {
        thumb.addEventListener('click', function() {
            if (this.classList.contains('selected')) return;
            document.querySelectorAll('.background-thumb').forEach(t => t.classList.remove('selected'));
            this.classList.add('selected');

            const html = document.documentElement;
            let bgPath = this.dataset.bg;
            if (!bgPath.startsWith('web/')) {
                bgPath = 'web/' + bgPath;
            }
            const newBg = `url('${bgPath}')`;

            bgFadeOverlay.style.backgroundImage = newBg;
            bgFadeOverlay.style.opacity = '0';
            void bgFadeOverlay.offsetWidth;
            bgFadeOverlay.style.opacity = '1';

            setTimeout(() => {
                html.style.backgroundImage = newBg;
                bgFadeOverlay.style.opacity = '0';
            }, 400);
        });
    });

    function updateClock() {
        const clock = document.getElementById('clock');
        if (!clock) return;
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        clock.textContent = `${hours}:${minutes}`;
    }
    updateClock();
    setInterval(updateClock, 1000);

    document.querySelectorAll('.accept_btn, .update_btn').forEach(btn => {
        btn.addEventListener('click', function () {
            this.classList.remove('active');
            void this.offsetWidth;
            this.classList.add('active');
            setTimeout(() => {
                this.classList.remove('active');
            }, 450);

            if (this.id === 'personal_accept') {
                const savedDiv = document.getElementById('personal_saved');
                if (savedDiv) {
                    savedDiv.classList.add('visible');
                    clearTimeout(savedDiv._hideTimeout);
                    savedDiv._hideTimeout = setTimeout(() => {
                        savedDiv.classList.remove('visible');
                    }, 5000);
                }
            }
            if (this.id === 'server_accept') {
                const savedDiv = document.getElementById('server_saved');
                if (savedDiv) {
                    savedDiv.classList.add('visible');
                    clearTimeout(savedDiv._hideTimeout);
                    savedDiv._hideTimeout = setTimeout(() => {
                        savedDiv.classList.remove('visible');
                    }, 5000);
                }
            }
            if (this.id === 'ftp_accept') {
                const savedDiv = document.getElementById('ftp_saved');
                if (savedDiv) {
                    savedDiv.classList.add('visible');
                    clearTimeout(savedDiv._hideTimeout);
                    savedDiv._hideTimeout = setTimeout(() => {
                        savedDiv.classList.remove('visible');
                    }, 5000);
                }
            }

            if (this.classList.contains('update_btn')) {
                const bodyChildren = Array.from(document.body.children);
                bodyChildren.forEach(el => {
                    if (el.id !== 'bg-fade-overlay' && el.tagName !== 'SCRIPT' && !el.classList.contains('icon')) {
                        el.classList.add('fade-out');
                    }
                });
                setTimeout(() => {
                    bodyChildren.forEach(el => {
                        if (el.id !== 'bg-fade-overlay' && el.tagName !== 'SCRIPT' && !el.classList.contains('icon')) {
                            el.style.display = 'none';
                        }
                    });
                    const icon = document.querySelector('.icon');
                    if (icon) {
                        icon.classList.remove('fade-out');
                        icon.style.display = '';
                        icon.classList.add('icon-center-animate');
                    }
                }, 600);
            }
        });
    });

    function updateIconVisibility() {
        const iconSelect = document.getElementById('icon-select');
        const icon = document.querySelector('.icon');
        if (!iconSelect || !icon) return;
        if (iconSelect.value === 'Hidden') {
            icon.classList.add('hide');
        } else {
            icon.classList.remove('hide');
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        const iconSelect = document.getElementById('icon-select');
        if (iconSelect) {
            iconSelect.addEventListener('change', updateIconVisibility);
            updateIconVisibility();
        }
    });

    let apiKey = localStorage.getItem('api_key');
    if (!apiKey) {
        apiKey = prompt("Please enter your API key:");
        if (apiKey) {
            localStorage.setItem('api_key', apiKey);
            const expiry = Date.now() + 60 * 60 * 10000;
            localStorage.setItem('api_key_expiry', expiry);
        }
    }
    const apiKeyExpiry = localStorage.getItem('api_key_expiry');
    if (apiKeyExpiry && Date.now() > parseInt(apiKeyExpiry, 10)) {
        localStorage.removeItem('api_key');
        localStorage.removeItem('api_key_expiry');
        location.reload();
    }

    async function loadPersonalSettings() {
        if (!apiKey) return;
        try {
            const res = await fetch('http://localhost:6969/api/user/get_self', {
                headers: { 'X-API-KEY': apiKey }
            });
            if (!res.ok) throw new Error('Failed to fetch user data');
            const user = await res.json();

            document.getElementById('name').value = user.name || '';
            document.getElementById('username').value = user.username || '';
            document.getElementById('password_web').value = user.password || '';

            let settings = {};
            try {
                settings = JSON.parse(user.settings || '{}');
            } catch (e) {}

            if (settings.background) {
                document.querySelectorAll('.background-thumb').forEach(thumb => {
                    if (thumb.dataset.bg === settings.background.replace('web/', '')) {
                        thumb.classList.add('selected');
                        document.documentElement.style.backgroundImage = `url('web/${settings.background.replace('web/', '')}')`;
                    } else {
                        thumb.classList.remove('selected');
                    }
                });
            }

            if (settings.iconVisible !== undefined) {
                document.getElementById('icon-select').value = settings.iconVisible ? 'Visible' : 'Hidden';
                updateIconVisibility();
            }
        } catch (err) {
            alert(err);
        }
    }

    async function savePersonalSettings() {
        if (!apiKey) return;
        const name = document.getElementById('name').value;
        const username = document.getElementById('username').value;
        const password = document.getElementById('password_web').value;
        const iconVisible = document.getElementById('icon-select').value === 'Visible';
        const selectedBg = document.querySelector('.background-thumb.selected')?.dataset.bg || '';

        const settings = {
            background: selectedBg,
            iconVisible: iconVisible
        };

        try {
            const res = await fetch('http://localhost:6969/api/user/edit_self', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-KEY': apiKey,
                },
                body: JSON.stringify({
                    name,
                    username,
                    password,
                    settings: JSON.stringify(settings)
                })
            });
            if (!res.ok) throw new Error('Failed to save settings');
        } catch (err) {
            alert('Could not save personal settings.');
        }
    }

    let currentServerSettings = null;

    async function loadServerSettings() {
        if (!apiKey) return;
        try {
            const res = await fetch('http://localhost:6969/api/get_settings', {
                headers: { 'X-API-KEY': apiKey }
            });
            if (!res.ok) throw new Error('Failed to fetch server settings');
            const settings = await res.json();
            currentServerSettings = settings;

            document.getElementById('path').value = settings.path || '';
            document.getElementById('host').value = settings.host || '';
            document.getElementById('port').value = settings.port || '';

            document.getElementById('ftp-server').value = settings.ftp ? 'On' : 'Off';
            document.getElementById('ftp-ip').value = settings.ftp_host || '';
            document.getElementById('ftp-port').value = settings.ftp_port || '';
            document.getElementById('ftp-timeout').value = settings.ftp_timeout || '';

            // --- Version check logic ---
            const currentVersionLabel = document.getElementById('current_version');
            const versionDiv = document.getElementById('version');
            const newestVersionLabel = document.getElementById('newest_version');
            const versionDescription = document.getElementById('version_description');
            if (currentVersionLabel) {
                currentVersionLabel.textContent = "Current version: " + (settings.version || "unknown");
            }
            try {
                // Fetch newest version and description from GitHub
                const [newestVersionRes, descRes] = await Promise.all([
                    fetch("https://raw.githubusercontent.com/bbarni2020/Shareify/refs/heads/main/info/version"),
                    fetch("https://raw.githubusercontent.com/bbarni2020/Shareify/refs/heads/main/info/version_dsc")
                ]);
                const newestVersion = (await newestVersionRes.text()).trim();
                const versionDsc = (await descRes.text()).trim();
                if ((settings.version || "").trim() !== newestVersion) {
                    if (versionDiv) versionDiv.style.display = "";
                    if (newestVersionLabel) newestVersionLabel.textContent = "Newest: " + newestVersion;
                    if (versionDescription) versionDescription.textContent = "Description: " + versionDsc;
                } else {
                    if (versionDiv) versionDiv.style.display = "none";
                    currentVersionLabel.textContent = "Current version: " + (settings.version || "unknown") + " (latest)";
                }
            } catch (e) {
                // If fetch fails, just hide versionDiv
                if (versionDiv) versionDiv.style.display = "none";
            }
            // --- end version check logic ---
        } catch (err) {
            alert('Could not load server settings.');
        }
    }

    function gatherServerSettingsFromFields() {
        return {
            ftp: document.getElementById('ftp-server').value === 'On',
            ftp_host: document.getElementById('ftp-ip').value,
            ftp_port: parseInt(document.getElementById('ftp-port').value, 10) || 0,
            ftp_timeout: parseInt(document.getElementById('ftp-timeout').value, 10) || 0,
            host: document.getElementById('host').value,
            path: document.getElementById('path').value,
            port: parseInt(document.getElementById('port').value, 10) || 0,
            version: currentServerSettings?.version || ''
        };
    }

    async function saveServerSettings() {
        if (!apiKey) return;
        const settings = gatherServerSettingsFromFields();
        try {
            const res = await fetch('http://localhost:6969/api/update_settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-KEY': apiKey
                },
                body: JSON.stringify(settings)
            });
            if (!res.ok) throw new Error('Failed to update server settings');
            currentServerSettings = settings;
        } catch (err) {
            alert('Could not save server settings.');
        }
    }

    document.addEventListener('DOMContentLoaded', loadServerSettings);

    document.getElementById('server_accept').addEventListener('click', saveServerSettings);
    document.getElementById('ftp_accept').addEventListener('click', saveServerSettings);

    document.addEventListener('DOMContentLoaded', loadPersonalSettings);

    document.getElementById('personal_accept').addEventListener('click', savePersonalSettings);

    document.querySelectorAll('.background-thumb').forEach(thumb => {
        thumb.addEventListener('click', savePersonalSettings);
    });
    document.getElementById('icon-select').addEventListener('change', savePersonalSettings);

    document.getElementById('leave').addEventListener('click', () => {
        localStorage.removeItem('api_key');
        localStorage.removeItem('api_key_expiry');
        location.reload();
    });
</script>
</html>