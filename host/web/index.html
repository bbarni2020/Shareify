<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shareify</title>
    <link rel="stylesheet" href="web/index.css">
    <link rel="shortcut icon" href="web/assets/icon.ico" type="image/x-icon">
    <style>
        .logout-fade-out {
            opacity: 0 !important;
            transition: opacity 0.6s cubic-bezier(0.4,0,0.2,1);
            pointer-events: none !important;
        }
        #bg-fade-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            pointer-events: none;
            opacity: 0;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            transition: opacity 0.4s cubic-bezier(0.4,0,0.2,1);
        }
.finder-toolbar {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 0 30px 0 30px;
    margin-top: 70px;
    margin-bottom: 5px;
    padding: 18px 18px 10px 18px;
    border-radius: 44px;
}

.finder-path-container {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    width: 100%;
}

.finder-path-input {
    flex: 1;
    font-size: 14px;
    color: #23232a;
    font-family: 'Kantumruy', sans-serif;
    font-weight: 600;
    padding: 6px 12px;
    border-radius: 18px;
    border: 1px solid rgba(60,67,71,0.15);
    background: rgba(255,255,255,0.5);
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.08);
    transition: all 0.2s ease-out;
    outline: none;
}

.finder-path-input:focus {
    border-color: rgba(65, 137, 230, 0.5);
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.08), 0 0 0 3px rgba(65, 137, 230, 0.15);
    background: rgba(255,255,255,0.7);
}

.finder-path-go {
    margin-left: 8px;
    padding: 6px 16px;
    border-radius: 18px;
    border: none;
    background: rgba(65, 137, 230, 0.18);
    color: #23232a;
    font-family: 'Kantumruy', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.18s, transform 0.18s;
}

.finder-path-go:hover {
    background: rgba(65, 137, 230, 0.3);
    transform: translateY(-2px);
}

.finder-path {
    font-size: 16px;
    color: #23232a;
    font-family: 'Kantumruy', sans-serif;
    font-weight: 600;
    margin-bottom: 6px;
    word-break: break-all;
}

.finder-selection-count {
    font-size: 15px;
    color: #23232a;
    font-family: 'Kantumruy', sans-serif;
    font-weight: 600;
    margin-right: 15px;
    opacity: 0;
    transition: opacity 0.2s ease-out;
}

.finder-selection-count.visible {
    opacity: 1;
}

.finder-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
}

.finder-selection-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.finder-always-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.finder-action-btn {
    padding: 7px 18px;
    border-radius: 18px;
    border: none;
    background: rgba(65, 137, 230, 0.12);
    color: #23232a;
    font-family: 'Kantumruy', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0px 2px 6px 0px rgba(60,67,71,0.08);
    transition: background 0.18s, box-shadow 0.18s, transform 0.18s, opacity 0.2s ease-out;
    opacity: 0;
    pointer-events: none;
}

.finder-action-btn.visible {
    opacity: 1;
    pointer-events: auto;
}

.finder-path-go {
    opacity: 1 !important;
    pointer-events: auto !important;
}

.finder-file-manager {
    display: flex;
    flex-wrap: wrap;
    gap: 20px 15px;
    padding: 15px 20px 10px 20px;
    margin: 0 auto;
    max-width: 98%;
    max-height: 380px;
    overflow-y: auto;
    left: 30px;
    right: 30px;
    border-radius: 36px;
}


.finder-file-manager::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.finder-file-manager::-webkit-scrollbar-thumb {
    background: rgba(101, 97, 146, 0.18);
    border-radius: 8px;
}

.finder-file-manager::-webkit-scrollbar-track {
    background: transparent;
}

    </style>
</head>
<body style="opacity:0; transition: opacity 0.5s;">
    <div class="container">
        <div class="app_icons" style="background: url(web/assets/finder.png) lightgray 50% / cover no-repeat;" onclick="finder_open()" id="finder-ontab">
            <div class="indicator" id="finder-indicator"></div>
        </div>
        <div class="app_icons" style="background: url(web/assets/user.png) lightgray 50% / cover no-repeat;" onclick="users_open()" id="users-ontab">
            <div class="indicator" id="users-indicator"></div>
        </div>
        <div class="app_icons" style="background: url(web/assets/nas.png) lightgray 50% / cover no-repeat;" onclick="nas_open()" id="nas-ontab">
            <div class="indicator" id="nas-indicator"></div>
        </div>
        <div class="app_icons" style="background: url(web/assets/settings.png) lightgray 50% / cover no-repeat;" onclick="settings_open()" id="settings-ontab">
            <div class="indicator" id="settings-indicator"></div>
        </div>
    </div>
    </div>
    <div class="clock_div">
        <div id="clock" class="clock_text"></div>
        <div class="clock_img"></div>
    </div>
    <div class="leave" id="leave"></div>
    <div class="window" id="finder-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="</div>none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Finder</div>
        <div class="finder-toolbar">
            <div class="finder-path-container">
                <input type="text" class="finder-path-input" id="finder-path" value="/home" placeholder="Enter path..." disabled="true">
            </div>
            <div class="finder-actions">
                <div class="finder-selection-count" id="finder-selection-count">0 items selected</div>
                <div class="finder-selection-buttons">
                    <button class="finder-action-btn" id="finder-dwonload-btn">Download</button>
                    <button class="finder-action-btn" id="finder-move-btn" style="display: none;">Move</button>
                    <button class="finder-action-btn" id="finder-delete-btn">Delete</button>
                    <button class="finder-action-btn" id="finder-rename-btn">Rename</button>
                </div>
                <div class="finder-always-buttons">
                    <button class="finder-action-btn visible" id="finder-addfile-btn">Upload</button>
                    <button class="finder-action-btn visible" id="finder-addfolder-btn">New folder</button>
                </div>
            </div>
        </div>
        <div class="finder-file-manager">
            <div class="finder-item file-folder">
                <div class="finder-icon"></div>
                <div class="finder-label">Documents</div>
            </div>
            <div class="finder-item file-picture">
                <div class="finder-icon"></div>
                <div class="finder-label">photo.jpg</div>
            </div>
        </div>
        <div class="resize_handle"></div>
    </div>
    <div class="window" id="users-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Users</div>
        <div class="sections_container">
            <div class="users-layout">
                <div class="users-left-column">
                    <div class="users-roles">
                        <div class="users-section-title">Roles</div>
                        <div class="users-section-buttons">
                            <button class="user-action-btn edit-btn" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40" fill="none">
                                    <circle cx="20" cy="20" r="20" fill="#3B82F6"/>
                                    <path d="M14 26h2l8-8-2-2-8 8v2z" fill="white"/>
                                    <path d="M22 12l2 2 2-2-2-2-2 2z" fill="white"/>
                                </svg>
                            </button>
                        </div>
                        <div class="users-section-content" id="roles-content">
                        </div>
                    </div>
                    
                    <div class="users-ftpusers">
                        <div class="users-section-title">FTP users</div>
                        <div class="users-section-buttons">
                            <button class="user-action-btn add-btn" id="ftp-create-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40" fill="none">
                                    <circle cx="20" cy="20" r="20" fill="#90E478"/>
                                    <line x1="20" y1="14" x2="20" y2="26" stroke="white" stroke-width="2" stroke-linecap="round"/>
                                    <line x1="14" y1="20" x2="26" y2="20" stroke="white" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                        <div class="users-section-content" id="ftpusers-content">
                        </div>
                    </div>
                </div>
                
                <div class="users-users">
                    <div class="users-section-title">Users</div>
                    <div class="users-section-buttons">
                        <button class="user-action-btn add-btn" id="user-create-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40" fill="none">
                                <circle cx="20" cy="20" r="20" fill="#90E478"/>
                                <line x1="20" y1="14" x2="20" y2="26" stroke="white" stroke-width="2" stroke-linecap="round"/>
                                <line x1="14" y1="20" x2="26" y2="20" stroke="white" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="users-section-content" id="users-content">
                    </div>
                </div>
            </div>
        </div>
        <div class="resize_handle"></div>
    </div>
    <div class="window" id="nas-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">NAS</div>
        <div class="sections_container">
            <div class="section_content resource-section-content" id="resource-meterse">
                <div id="resource-meters">
                    <div class="system-control-buttons">
                        <button class="system-btn shutdown" id="shutdown-btn"></button>
                        <button class="system-btn restart" id="restart-btn"></button>
                    </div>
                    <div class="resource-meter">
                        <svg id="cpu-meter" width="120" height="120"></svg>
                        <div class="meter-label">CPU</div>
                    </div>
                    <div class="resource-meter">
                        <svg id="memory-meter" width="120" height="120"></svg>
                        <div class="meter-label">Memory</div>
                    </div>
                    <div class="resource-meter">
                        <svg id="disk-meter" width="120" height="120"></svg>
                        <div class="meter-label">Disk</div>
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="section_title">
                    <p>Command line</p>
                    <div class="dropdown_icon"></div>
                </div>
                <div class="section_content">
                <div class="command-line-section">
                    <div class="command-line-output" id="cli-output">
                        Welcome to Shareify CLI!<br>
                    </div>
                    <div class="command-line-input-row">
                        <span class="command-line-prompt">$</span>
                        <input class="command-line-input" id="cli-input" type="text" autocomplete="off" placeholder="Type a command..." />
                    </div>
                </div>
                </div>
            </div>
            <div class="section" id="log-section">
                <div class="section_title">
                    <p>Logs</p>
                    <div class="dropdown_icon"></div>
                </div>
                <div class="section_content">
                    <div class="database-table-container">
                    <table class="database-table">
                        <thead>
                        <tr>
                            <th>Time</th>
                            <th>Action</th>
                            <th>Ip</th>
                        </tr>
                        </thead>
                        <tbody id="log-table-body">
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="resize_handle"></div>
    </div>
    <div class="window" id="settings-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Settings</div>
        <div class="sections_container">
            <div class="section">
                <div class="section_title">
                    <p>Personal settings</p>
                    <div class="dropdown_icon"></div>
                </div>
                <div class="section_content">
                    <p style="font-size: 17px;">Here you can edit your personal settings.</p>
                    <div class="horizontal-align">
                        <label for="name">Preferred name:</label>
                        <input type="text" name="name" id="name" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="username">Username:</label>
                        <input type="text" name="username" id="username" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="password_web">Password:</label>
                        <input type="text" name="password_web" id="password_web" class="textbox">
                    </div>
                    <div class="horizontal-align" style="margin-top: 10px;">
                        <div style="width: 100%;"></div>
                        <div id="personal_saved" class="saved_text">Saved</div>
                        <div class="accept_btn" id="personal_accept"><img src="web/assets/pipe.png" alt="pipe" class="centered-img"></div>
                    </div>
                    <div class="horizontal-align" style="margin-top: 10px;">
                        <label for="icon-select">Icon (in background):</label>
                        <select id="icon-select">
                            <option>Visible</option>
                            <option>Hidden</option>
                        </select>
                    </div>
                    <div style="margin-top: 18px; margin-bottom: 8px; font-size: 17px;">Choose background:</div>
                    <div class="background-selector" id="background-selector">
                        <div class="background-thumb selected" data-bg="assets/backgrounds/back1.png" style="background-image: url('web/assets/backgrounds/back1.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back2.png" style="background-image: url('web/assets/backgrounds/back2.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back3.png" style="background-image: url('web/assets/backgrounds/back3.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back4.png" style="background-image: url('web/assets/backgrounds/back4.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back5.png" style="background-image: url('web/assets/backgrounds/back5.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back6.png" style="background-image: url('web/assets/backgrounds/back6.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back7.png" style="background-image: url('web/assets/backgrounds/back7.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back8.png" style="background-image: url('web/assets/backgrounds/back8.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back9.png" style="background-image: url('web/assets/backgrounds/back9.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back10.png" style="background-image: url('web/assets/backgrounds/back10.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back11.png" style="background-image: url('web/assets/backgrounds/back11.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back12.png" style="background-image: url('web/assets/backgrounds/back12.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back13.png" style="background-image: url('web/assets/backgrounds/back13.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back14.png" style="background-image: url('web/assets/backgrounds/back14.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back15.png" style="background-image: url('web/assets/backgrounds/back15.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back16.png" style="background-image: url('web/assets/backgrounds/back16.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back17.png" style="background-image: url('web/assets/backgrounds/back17.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back18.png" style="background-image: url('web/assets/backgrounds/back18.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back19.png" style="background-image: url('web/assets/backgrounds/back19.png');"></div>
                    </div>
                </div>
            </div>
            <div class="section" id="server-section">
                <div class="section_title">
                    <p>Server settings</p>
                    <div class="dropdown_icon"></div>
                </div>
                <div class="section_content">
                    <p style="font-size: 17px;">Here you can edit the server's general settings.</p>
                    <div class="horizontal-align">
                        <label for="path">Default path:</label>
                        <input type="text" name="path" id="path" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="host">Host ip:</label>
                        <input type="text" name="host" id="host" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="port">Host port:</label>
                        <input type="number" name="port" id="port" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="ftp-server">FTP server:</label>
                        <select id="ftp-server">
                            <option>On</option>
                            <option>Off</option>
                        </select>
                    </div>
                    <div class="horizontal-align" style="margin-top: 10px;">
                        <div style="width: 100%;"></div>
                        <div id="server_saved" class="saved_text">Saved</div>
                        <div class="accept_btn" id="server_accept"><img src="web/assets/pipe.png" alt="pipe" class="centered-img"></div>
                    </div>
                    <div class="horizontal-align" style="margin-top: 25px;">
                        <label id="current_version">Current version: loading...</label>
                    </div>
                    <div id="version" style="margin-top: 5px;">
                        <div class="horizontal-align" id="update-sec">
                            <h4 id="newest_version">Newest: loading...</h2>
                            <div style="width: 90%;"></div>
                            <h5>Update</h6>
                            <div class="update_btn" id="verison"><img src="web/assets/go.png" alt="Update" class="centered-img"></div>
                        </div>
                        <h5 id="version_description">Description: loading...</h3>
                    </div>
                </div>
            </div>
            <div class="section" id="ftp-section">
                <div class="section_title">
                    <p>FTP settings</p>
                    <div class="dropdown_icon"></div>
                </div>
                <div class="section_content">
                    <p style="font-size: 17px;">Here you can edit the server's general settings.</p>
                    <div class="horizontal-align">
                        <label for="ftp-ip">FTP server ip:</label>
                        <input type="text" name="ftp-ip" id="ftp-ip" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="ftp-port">FTP server port:</label>
                        <input type="number" name="ftp-port" id="ftp-port" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="ftp-timeout">FTP timeout:</label>
                        <input type="number" name="ftp-timeout" id="ftp-timeout" class="textbox">
                    </div>
                    <div class="horizontal-align" style="margin-top: 10px;">
                        <div style="width: 100%;"></div>
                        <div id="ftp_saved" class="saved_text">Saved</div>
                        <div class="accept_btn" id="ftp_accept"><img src="web/assets/pipe.png" alt="pipe" class="centered-img"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="resize_handle"></div>
    </div>
    <div class="window upload-window" id="upload-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Upload</div>
        <div class="upload-content">
            <div class="upload-drop-zone" id="upload-drop-zone">
                <div class="upload-icon"></div>
                <div class="upload-text">
                    <h3>Drop files here or click to browse</h3>
                    <p>Select files to upload to the current directory</p>
                </div>
                <input type="file" class="upload-file-input" id="upload-file-input" multiple>
            </div>
            <div class="upload-actions">
                <div class="upload-progress" id="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">0%</div>
                </div>
                <button class="upload-btn" id="upload-btn">
                    <span>Upload Files</span>
                </button>
            </div>
        </div>
        <div class="resize_handle"></div>
    </div>
    
    <div class="icon hide"></div>
    
    <div class="window user-create-window" id="user-create-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Create User</div>
        <div class="user-form-content">
            <div class="user-form-section">
                <div class="horizontal-align">
                    <label for="user-username">Username:</label>
                    <input type="text" name="user-username" id="user-username" class="textbox" placeholder="Enter username">
                </div>
                <div class="horizontal-align">
                    <label for="user-password">Password:</label>
                    <input type="password" name="user-password" id="user-password" class="textbox" placeholder="Enter password">
                </div>
                <div class="horizontal-align">
                    <label for="user-name">Full name:</label>
                    <input type="text" name="user-name" id="user-name" class="textbox" placeholder="Enter full name">
                </div>
                <div class="user-endpoints-section">
                    <label class="endpoints-label">Permissions:</label>
                    <div class="endpoints-grid" id="user-endpoints-grid">
                    </div>
                </div>
                <div class="horizontal-align">
                    <label for="user-paths">Accessible paths:</label>
                    <input type="text" name="user-paths" id="user-paths" class="textbox" placeholder="JSON format (optional)">
                </div>
                <div class="horizontal-align">
                    <label for="user-paths-write">Writable paths:</label>
                    <input type="text" name="user-paths-write" id="user-paths-write" class="textbox" placeholder="JSON format (optional)">
                </div>
                
                <div class="horizontal-align" style="margin-top: 20px;">
                    <div style="width: 100%;"></div>
                    <div id="user_saved" class="saved_text">User Created</div>
                    <div class="accept_btn" id="user_create_btn"><img src="web/assets/pipe.png" alt="create" class="centered-img"></div>
                </div>
            </div>
        </div>
        <div class="resize_handle"></div>
    </div>
    
    <div class="window user-edit-window" id="user-edit-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Edit User</div>
        <div class="user-form-content">
            <div class="user-form-section">
                <div class="horizontal-align">
                    <label for="edit-user-username">Username:</label>
                    <input type="text" name="edit-user-username" id="edit-user-username" class="textbox" placeholder="Enter username">
                </div>
                <div class="horizontal-align">
                    <label for="edit-user-password">New Password:</label>
                    <input type="password" name="edit-user-password" id="edit-user-password" class="textbox" placeholder="Enter new password (leave empty to keep current)">
                </div>
                <div class="horizontal-align">
                    <label for="edit-user-name">Full name:</label>
                    <input type="text" name="edit-user-name" id="edit-user-name" class="textbox" placeholder="Enter full name">
                </div>
                <div class="user-endpoints-section">
                    <label class="endpoints-label">Permissions:</label>
                    <div class="endpoints-grid" id="edit-user-endpoints-grid">
                    </div>
                </div>
                <div class="horizontal-align">
                    <label for="edit-user-paths">Accessible paths:</label>
                    <input type="text" name="edit-user-paths" id="edit-user-paths" class="textbox" placeholder="JSON format (optional)">
                </div>
                <div class="horizontal-align">
                    <label for="edit-user-paths-write">Writable paths:</label>
                    <input type="text" name="edit-user-paths-write" id="edit-user-paths-write" class="textbox" placeholder="JSON format (optional)">
                </div>  
                <div class="user-form-divider"></div>
                <div class="user-form-subtitle" data-text="Connected FTP Users">Connected FTP Users</div>
                
                <div class="ftp-users-connection-section">
                    <div class="ftp-users-list" id="edit-user-ftp-users-list">
                        <div class="ftp-users-empty-state" id="ftp-users-empty">
                            <div class="empty-state-icon">👥</div>
                            <div class="empty-state-text">No FTP users connected to this user</div>
                        </div>
                    </div>
                    <div class="ftp-users-actions">
                        <button type="button" class="ftp-connect-btn" id="connect-ftp-user-btn">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M8 1V15M1 8H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Connect FTP User
                        </button>
                    </div>
                </div>
                
                <div class="horizontal-align" style="margin-top: 30px;">
                    <div style="width: 100%;"></div>
                    <div id="user_edit_saved" class="saved_text">User Updated</div>
                    <div class="accept_btn" id="user_edit_btn"><img src="web/assets/pipe.png" alt="update" class="centered-img"></div>
                </div>
            </div>
        </div>
        <div class="resize_handle"></div>
    </div>
    
    <div class="window ftp-edit-window" id="ftp-edit-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Edit FTP</div>
        <div class="ftp-form-content">
            <div class="ftp-form-section">
                <div class="ftp-form-group">
                    <label for="ftp-edit-username">FTP Username</label>
                    <input type="text" id="ftp-edit-username" class="ftp-input" placeholder="Enter FTP username" readonly>
                </div>
                <div class="ftp-form-group">
                    <label for="ftp-edit-password">FTP Password</label>
                    <input type="password" id="ftp-edit-password" class="ftp-input" placeholder="Enter new password (leave empty to keep current)">
                </div>
                <div class="ftp-form-group">
                    <label for="ftp-edit-path">Home Directory</label>
                    <input type="text" id="ftp-edit-path" class="ftp-input" placeholder="FTP home directory path">
                </div>
                <div class="ftp-form-group">
                    <label>Permissions</label>
                    <div class="ftp-permissions-group">
                        <div class="ftp-permission-item">
                            <input type="checkbox" id="ftp-edit-read" class="ftp-permission-checkbox" checked>
                            <label for="ftp-edit-read">Read</label>
                        </div>
                        <div class="ftp-permission-item">
                            <input type="checkbox" id="ftp-edit-write" class="ftp-permission-checkbox">
                            <label for="ftp-edit-write">Write</label>
                        </div>
                        <div class="ftp-permission-item">
                            <input type="checkbox" id="ftp-edit-delete" class="ftp-permission-checkbox">
                            <label for="ftp-edit-delete">Delete</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ftp-form-actions">
                <div style="width: 100%;"></div>
                <div id="ftp_edit_saved" class="saved_text">Updated</div>
                <div class="accept_btn" id="ftp_edit_btn"><img src="web/assets/pipe.png" alt="update" class="centered-img"></div>
            </div>
        </div>
        <div class="resize_handle"></div>
    </div>
    
    <div class="window ftp-create-window" id="ftp-create-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Create FTP</div>
        <div class="ftp-form-content">
            <div class="ftp-form-section">
                <div class="ftp-form-group">
                    <label for="ftp-create-username">FTP Username</label>
                    <input type="text" id="ftp-create-username" class="ftp-input" placeholder="Enter FTP username">
                </div>
                <div class="ftp-form-group">
                    <label for="ftp-create-password">FTP Password</label>
                    <input type="password" id="ftp-create-password" class="ftp-input" placeholder="Enter FTP password">
                </div>
                <div class="ftp-form-group">
                    <label for="ftp-create-path">Home Directory</label>
                    <input type="text" id="ftp-create-path" class="ftp-input" placeholder="FTP home directory path (optional)">
                </div>
                <div class="ftp-form-group">
                    <label>Permissions</label>
                    <div class="ftp-permissions-group">
                        <div class="ftp-permission-item">
                            <input type="checkbox" id="ftp-create-read" class="ftp-permission-checkbox" checked>
                            <label for="ftp-create-read">Read</label>
                        </div>
                        <div class="ftp-permission-item">
                            <input type="checkbox" id="ftp-create-write" class="ftp-permission-checkbox">
                            <label for="ftp-create-write">Write</label>
                        </div>
                        <div class="ftp-permission-item">
                            <input type="checkbox" id="ftp-create-delete" class="ftp-permission-checkbox">
                            <label for="ftp-create-delete">Delete</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ftp-form-actions">
                <div style="width: 100%;"></div>
                <div id="ftp_create_saved" class="saved_text">Created</div>
                <div class="accept_btn" id="ftp_create_btn"><img src="web/assets/pipe.png" alt="create" class="centered-img"></div>
            </div>
        </div>
        <div class="resize_handle"></div>
    </div>
    
    <div class="window role-details-window" id="role-details-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Role Details</div>
        <div class="role-details-content">
            <div class="role-details-header">
                <div class="role-endpoint-name" id="role-endpoint-name"></div>
                <div class="role-endpoint-method" id="role-endpoint-method"></div>
            </div>
            <div class="role-details-description">
                <h3>Description</h3>
                <p id="role-endpoint-description"></p>
            </div>
            <div class="role-details-auth" style="display: none;">
                <h3>Authentication</h3>
                <p id="role-endpoint-auth"></p>
            </div>
            <div class="role-details-users" id="role-details-users">
                <h3>Users with Access</h3>
                <div class="role-users-list" id="role-users-list"></div>
                <div class="role-users-actions">
                    <div class="role-user-selector">
                        <button class="role-add-user-btn" id="role-add-user-btn">Add User</button>
                        <div class="role-user-dropdown" id="role-user-dropdown"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="resize_handle"></div>
    </div>
    
    <div class="notification-overlay" id="notification-overlay">
        <div class="notification-header">
            <h3 class="notification-title" id="notification-title"></h3>
            <button class="notification-close" id="notification-close">×</button>
        </div>
        <p class="notification-content" id="notification-content"></p>
    </div>
</body>
<script>
    const baseURL = window.location.origin;
    
    async function checkForNotifications() {
        try {
            const response = await fetch('https://raw.githubusercontent.com/bbarni2020/Shareify/refs/heads/main/info/msg.json');
            if (response.ok) {
                const data = await response.json();
                if (data.active && data.message) {
                    showNotification(data.message, data.type || 'info');
                }
            }
        } catch (error) {
            console.log('Could not fetch notification message');
        }
    }
    
    function showNotification(message, type = 'info') {
        const overlay = document.getElementById('notification-overlay');
        const title = document.getElementById('notification-title');
        const content = document.getElementById('notification-content');
        const closeBtn = document.getElementById('notification-close');
        
        if (!overlay || !title || !content || !closeBtn) return;
        
        overlay.className = `notification-overlay ${type}`;
        
        const typeTitle = {
            'info': 'Information',
            'success': 'Success',
            'warning': 'Warning',
            'error': 'Error'
        };
        
        title.textContent = typeTitle[type] || 'Notification';
        content.textContent = message;
        
        overlay.classList.add('show');
        
        const hideNotification = () => {
            overlay.classList.remove('show');
            overlay.classList.add('hide');
            setTimeout(() => {
                overlay.classList.remove('hide');
            }, 400);
        };
        
        closeBtn.onclick = hideNotification;
        
        setTimeout(hideNotification, 8000);
    }
    
    window.addEventListener('DOMContentLoaded', () => {
        document.body.style.opacity = '1';
        selfRoles();
        fetchResourceData();
        checkForNotifications();
    });
    
    function isFunctionAvailable(access, element) {
        if (!element) return;
        if (access == false || !access) {
            element.style.display = 'none';
        } else {
            element.style.display = '';
        }
    }

    async function fetchResourceData() {
        try {
            const response = await authenticatedFetch(`${baseURL}/api/resources`, {
                method: 'GET'
            });
            
            if (response && response.ok) {
                const data = await response.json();
                drawMeter('cpu-meter', data.cpu || 0, 'cpu');
                drawMeter('memory-meter', data.memory || 0, 'memory');
                drawMeter('disk-meter', data.disk || 0, 'disk');
                meterLastPercent['cpu-meter'] = data.cpu || 0;
                meterLastPercent['memory-meter'] = data.memory || 0;
                meterLastPercent['disk-meter'] = data.disk || 0;
                lastResourceData = data;
            }
        } catch (error) {
            console.error('Error fetching resource data:', error);
            drawMeter('cpu-meter', 0, 'cpu');
            drawMeter('memory-meter', 0, 'memory');
            drawMeter('disk-meter', 0, 'disk');
            meterLastPercent['cpu-meter'] = 0;
            meterLastPercent['memory-meter'] = 0;
            meterLastPercent['disk-meter'] = 0;
        }
    }
    
    async function selfRoles() {
        const jwtToken = localStorage.getItem('jwt_token');
        if (!jwtToken) {
            redirectToAuth();
            return;
        }

        try {
            const response = await authenticatedFetch(`${baseURL}/api/role/self`, {
                method: 'GET'
            });
            
            if (!response || !response.ok) {
                throw new Error(`HTTP ${response?.status || 'Unknown'}: Failed to verify user permissions`);
            }
            
            const data = await response.json();
            userPermissions = data;
            const hasCommandAccess = data['/api/command'] === true;

            const cliSection = document.querySelector('.section').querySelector('.section_title p');
            if (cliSection && cliSection.textContent === 'Command line') {
                const section = cliSection.closest('.section');
                if (!hasCommandAccess) {
                    section.style.display = 'none';
                } else {
                    section.style.display = '';
                }
            }

            isFunctionAvailable(data['/api/finder'], document.getElementById('finder-ontab'));
            isFunctionAvailable(data['/api/create_folder'], document.getElementById('finder-addfolder-btn'));
            isFunctionAvailable(data['/api/delete_folder'] || data['/api/delete_file'], document.getElementById('finder-delete-btn'));
            isFunctionAvailable(data['/api/rename_folder'] || data['/api/rename_file'], document.getElementById('finder-rename-btn'));
            isFunctionAvailable(data['/api/download'], document.getElementById('finder-dwonload-btn'));
            isFunctionAvailable(data['/api/upload'], document.getElementById('finder-addfile-btn'));
            isFunctionAvailable(data['/api/ftp/create_user'], document.getElementById('ftp-create-btn'));
            isFunctionAvailable(data['/api/resources'], document.getElementById('resource-meterse'));
            isFunctionAvailable(data['/api/get_logs'], document.getElementById('log-section'));
            isFunctionAvailable(data['/api/command'] || data['/api/resources'] || data['/api/get_logs'], document.getElementById('nas-ontab'));
            isFunctionAvailable(data['/api/user/create'], document.getElementById('user-create-btn'));
            isFunctionAvailable(data['/api/update'], document.getElementById('version_description'));
            isFunctionAvailable(data['/api/update'], document.getElementById('update-sec'));
            isFunctionAvailable(data['/api/get_version'], document.getElementById('current_version'));
            isFunctionAvailable(data['/api/update_settings'], document.getElementById('server_accept'));
            isFunctionAvailable(data['/api/update_settings'], document.getElementById('ftp_accept'));
            if (!data['/api/update_settings']) {
                document.getElementById('path').disabled = true;
                document.getElementById('host').disabled = true;
                document.getElementById('port').disabled = true;
                document.getElementById('ftp-server').disabled = true;
                document.getElementById('ftp-ip').disabled = true;
                document.getElementById('ftp-port').disabled = true;
                document.getElementById('ftp-timeout').disabled = true;
            }
            isFunctionAvailable(data['/api/get_settings'], document.getElementById('server-section'));
            isFunctionAvailable(data['/api/get_settings'], document.getElementById('ftp-section'));
            isFunctionAvailable(data['/api/role/edit'], document.getElementById('role-add-user-btn'));
            isFunctionAvailable(data['/api/role/edit'], document.getElementById('role-details-users'));
            document.querySelectorAll('.edit-ftp-btn').forEach(btn => {
                isFunctionAvailable(data['/api/ftp/edit_user'] === true, btn);
            });
            isFunctionAvailable(data['/api/shutdown'], document.getElementById('shutdown-btn'));
            isFunctionAvailable(data['/api/restart'], document.getElementById('restart-btn'));
            if (!(data['/api/ftp/get_users'] && data['/api/user/get_all'] && data['/api/role/get'])) {
                document.getElementById('users-ontab').style.display = 'none';
            }
        } catch (error) {
            showNotification('Error verifying user permissions', 'error');
            redirectToAuth();
        }
    }
    let jwtToken = localStorage.getItem('jwt_token');
    let userPermissions = {};
    
    if (!jwtToken || isTokenExpired()) {
        redirectToAuth();
    }

    function startTokenExpirationMonitor() {
        setInterval(() => {
            if (isTokenExpired()) {
                showNotification('Token expired, redirecting to login', 'warning');
                redirectToAuth();
            }
        }, 60000);
    }

    startTokenExpirationMonitor();

    function isTokenExpired() {
        const expiry = localStorage.getItem('jwt_expiry');
        if (!expiry) return true;
        return Date.now() >= parseInt(expiry);
    }

    function redirectToAuth() {
        localStorage.removeItem('jwt_token');
        localStorage.removeItem('jwt_expiry');
        window.location.href = '/auth';
    }

    function getAuthHeaders() {
        const token = localStorage.getItem('jwt_token');
        if (!token || isTokenExpired()) {
            redirectToAuth();
            return {};
        }
        return { 'Authorization': `Bearer ${token}` };
    }

    async function authenticatedFetch(url, options = {}) {
        if (isTokenExpired()) {
            redirectToAuth();
            return;
        }

        const headers = {
            ...getAuthHeaders(),
            ...options.headers
        };

        try {
            const response = await fetch(url, {
                ...options,
                headers
            });

            if (response.status === 401) {
                const responseData = await response.json().catch(() => ({}));
                if (responseData.error === 'Token expired' || responseData.error === 'Invalid token' || responseData.error === 'Unauthorized') {
                    return;
                }
            }

            return response;
        } catch (error) {
            showNotification('Authenticated fetch error', 'error');
            throw error;
        }
    }

    const windows = document.querySelectorAll('.window');
    let zIndexCounter = 1;
    let isDragging = false;
    let isResizing = false;
    let offsetX, offsetY, startWidth, startHeight;
    let activeDragWindow = null;

    function getTopmostWindow() {
        let topWindow = null;
        let topZ = -Infinity;
        windows.forEach(w => {
            const z = parseInt(w.style.zIndex) || 0;
            if (w.classList.contains('show') && z > topZ) {
                topZ = z;
                topWindow = w;
            }
        });
        return topWindow;
    }

    windows.forEach((windowElement) => {
        const exitButton = windowElement.querySelector('.exit_btn');
        const resizeHandle = windowElement.querySelector('.resize_handle');

        exitButton.addEventListener('click', () => {
            const windowId = windowElement.id;
            const indicatorId = `${windowId.split('-')[0]}-indicator`;
            windowElement.classList.add('hide');
            windowElement.classList.remove('show');
            updateIndicator(windowId, indicatorId);
        });

        windowElement.addEventListener('mousedown', (e) => {
            if (e.target === resizeHandle || e.target === exitButton) return;
            bringToFront(windowElement);
            if (getTopmostWindow() !== windowElement) return;
            isDragging = true;
            activeDragWindow = windowElement;
            offsetX = e.clientX - windowElement.offsetLeft;
            offsetY = e.clientY - windowElement.offsetTop;
            windowElement.style.cursor = 'grabbing';
        });

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            offsetX = e.clientX;
            offsetY = e.clientY;
            startWidth = windowElement.offsetWidth;
            startHeight = windowElement.offsetHeight;
            e.stopPropagation();
            bringToFront(windowElement);
        });
    });

    document.addEventListener('mousemove', (e) => {
        if (isDragging && activeDragWindow) {
            activeDragWindow.style.left = `${e.clientX - offsetX}px`;
            activeDragWindow.style.top = `${e.clientY - offsetY}px`;
        } else if (isResizing) {
            const activeWindow = document.querySelector('.window.show');
            if (activeWindow) {
                const newWidth = Math.max(startWidth + (e.clientX - offsetX), 300);
                const newHeight = Math.max(startHeight + (e.clientY - offsetY), 200);
                activeWindow.style.width = `${newWidth}px`;
                activeWindow.style.height = `${newHeight}px`;
            }
        }
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
        isResizing = false;
        activeDragWindow = null;
        document.body.style.cursor = 'default';
    });

    function bringToFront(windowElement) {
        zIndexCounter++;
        windowElement.style.zIndex = zIndexCounter;
    }

    function updateIndicator(windowId, indicatorId) {
        const windowElement = document.getElementById(windowId);
        const indicatorElement = document.getElementById(indicatorId);
        if (windowElement && indicatorElement) {
            if (windowElement.classList.contains('show')) {
                indicatorElement.classList.add('active');
            } else {
                indicatorElement.classList.remove('active');
            }
        }
    }
    function getFileTypeClass(fileName) {
        const extension = fileName.split('.').pop().toLowerCase();
        if (!extension || fileName.indexOf('.') === -1) {
            return 'file-folder';
        }
        
        switch (extension) {
            case 'jpg':
            case 'jpeg':
            case 'png':
            case 'gif':
            case 'bmp':
            case 'svg':
            case 'webp':
                return 'file-picture';
            case 'mp4':
            case 'webm':
            case 'avi':
            case 'mov':
            case 'wmv':
            case 'mkv':
            case 'flv':
                return 'file-video';
            case 'zip':
            case 'rar':
            case '7z':
            case 'tar':
            case 'gz':
                return 'file-zip';
            case 'doc':
            case 'docx':
                return 'file-docx';
            case 'xls':
            case 'xlsx':
            case 'csv':
                return 'file-xlsx';
            case 'ppt':
            case 'pptx':
                return 'file-pptx';
            case 'txt':
            case 'md':
            case 'json':
            case 'xml':
            case 'html':
            case 'css':
            case 'js':
                return 'file-text';
            case 'pdf':
                return 'file-pdf';
            default:
                return 'file-unknown';
        }
    }

    async function loadInitialPaths() {
        try {
            const jwtToken = localStorage.getItem('jwt_token');
            if (!jwtToken) {
                showNotification('JWT token not found', 'error');
                return;
            }

            const response = await fetch(`${baseURL}/api/user/get_self`, {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Failed to load paths');
            }

            const data = await response.json();
            let paths = [];
            
            if (data.paths) {
                try {
                    paths = JSON.parse(data.paths);
                } catch (e) {
                    paths = [];
                }
            }
            
            const fileManager = document.querySelector('.finder-file-manager');
            fileManager.innerHTML = '';
            
            if (paths.length === 0) {
                loadFolderContents('');
                return;
            }
            
            if (paths.length === 1 && paths[0] === '') {
                loadFolderContents('');
                return;
            }
            
            paths.forEach(path => {
                const folderElement = document.createElement('div');
                folderElement.className = 'finder-item file-folder';
                folderElement.dataset.path = path;
                folderElement.innerHTML = `
                    <div class="finder-icon"></div>
                    <div class="finder-label">${path.split('/').pop() || path}</div>
                `;
                folderElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (e.ctrlKey || e.metaKey) return;
                    loadFolderContents(path);
                });
                fileManager.appendChild(folderElement);
            });

            const pathInput = document.getElementById('finder-path');
            if (pathInput) {
                pathInput.value = '/';
            }

            setupFileSelection();
        } catch (error) {
            console.error('Error loading paths:', error);
            loadFolderContents('');
        }
    }

    function setupFileSelection() {
        const fileActionButtons = document.querySelectorAll('.finder-selection-buttons .finder-action-btn');
        const selectionCountElement = document.getElementById('finder-selection-count');
        
        document.querySelectorAll('.finder-file-manager .finder-item:not(.no-select)').forEach(item => {
            item.addEventListener('click', function(e) {
                if (!(e.ctrlKey || e.metaKey)) return;
                e.stopPropagation();
                this.classList.toggle('selected');

                const selectedItems = document.querySelectorAll('.finder-item.selected');
                const count = selectedItems.length;
                selectionCountElement.textContent = count === 1
                    ? "1 item selected"
                    : `${count} items selected`;
                selectionCountElement.classList.toggle('visible', count > 0);
                fileActionButtons.forEach(btn => {
                    if (btn.id === 'finder-rename-btn') {
                        btn.classList.toggle('visible', count === 1);
                    } else {
                        btn.classList.toggle('visible', count > 0);
                    }
                });
            });
        });
    }

    function updateCreationButtonsState(path) {
        const addFileBtn = document.getElementById('finder-addfile-btn');
        const addFolderBtn = document.getElementById('finder-addfolder-btn');
        const isRootPath = path === '/' || path === '';
        
        if (addFileBtn && addFolderBtn) {
            if (isRootPath) {
                addFileBtn.classList.add('disabled');
                addFileBtn.classList.remove('visible');
                addFolderBtn.classList.add('disabled');
                addFolderBtn.classList.remove('visible');
            } else {
                addFileBtn.classList.remove('disabled');
                addFileBtn.classList.add('visible');
                addFolderBtn.classList.remove('disabled');
                addFolderBtn.classList.add('visible');
            }
        }
    }

    async function loadFolderContents(path) {
        try {
            const jwtToken = localStorage.getItem('jwt_token');
            if (!jwtToken) {
                showNotification('JWT token not found', 'error');
                return;
            }

            let url = `${baseURL}/api/finder`;
            if (path) {
                url += `?path=${encodeURIComponent(path)}`;
            }

            const response = await fetch(url, {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Failed to load folder contents');
            }

            const data = await response.json();
            const items = data.items || [];
            
            const fileManager = document.querySelector('.finder-file-manager');
            fileManager.innerHTML = '';
            
            if (path && path !== '/' && path.length > 1) {
                const backElement = document.createElement('div');
                backElement.className = 'finder-item file-folder no-select';
                const parentPath = path.split('/').slice(0, -1).join('/') || '';
                backElement.dataset.path = parentPath;
                backElement.innerHTML = `
                    <div class="finder-icon"></div>
                    <div class="finder-label">..</div>
                `;
                backElement.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (e.ctrlKey || e.metaKey) return;
                    
                    const jwtToken = localStorage.getItem('jwt_token');
                    if (jwtToken) {
                        try {
                            const response = await fetch(`${baseURL}/api/user/get_self`, {
                                headers: getAuthHeaders()
                            });
                            if (response.ok) {
                                const data = await response.json();
                                if (data.paths) {
                                    const paths = JSON.parse(data.paths);
                                    if (paths.includes(path)) {
                                        loadInitialPaths();
                                        return;
                                    }
                                }
                            }
                        } catch (e) {}
                    }
                    
                    if (parentPath === '' || parentPath === '/') {
                        loadInitialPaths();
                    } else {
                        loadFolderContents(parentPath);
                    }
                });
                fileManager.appendChild(backElement);
            }
            
            const pathInput = document.getElementById('finder-path');
            if (pathInput) {
                let displayedPath = path || '/';
                if (!displayedPath.startsWith('/')) {
                    displayedPath = '/' + displayedPath;
                }
                if (displayedPath.length > 1 && displayedPath.endsWith('/')) {
                    displayedPath = displayedPath.slice(0, -1);
                }
                pathInput.value = displayedPath;
                updateCreationButtonsState(displayedPath);
            }
            
            items.forEach(item => {
                const itemPath = path ? `${path === '/' ? '' : path}/${item}` : item;
                const fileTypeClass = getFileTypeClass(item);
                const itemElement = document.createElement('div');
                itemElement.className = `finder-item ${fileTypeClass}`;
                itemElement.dataset.path = itemPath;
                itemElement.innerHTML = `
                    <div class="finder-icon"></div>
                    <div class="finder-label">${item}</div>
                `;
                if (fileTypeClass === 'file-folder') {
                    itemElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (e.ctrlKey || e.metaKey) return;
                        loadFolderContents(itemPath);
                    });
                }
                fileManager.appendChild(itemElement);
            });

            const selectionCountElement = document.getElementById('finder-selection-count');
            if (selectionCountElement) {
                selectionCountElement.textContent = "0 items selected";
                selectionCountElement.classList.remove('visible');
            }
            
            document.querySelectorAll('.finder-selection-buttons .finder-action-btn').forEach(btn => {
                btn.classList.remove('visible');
            });
            
            setupFileSelection();
        } catch (error) {
            showNotification('Failed to load folder contents. Please try again.', 'error');
        }
    }

    function finder_open() {
        const windowElement = document.getElementById('finder-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            updateIndicator('finder-window', 'finder-indicator');
            loadInitialPaths();
        }
    }

    function users_open() {
        const windowElement = document.getElementById('users-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            updateIndicator('users-window', 'users-indicator');
            loadUsersData();
            loadFTPUsers();
            loadRoles();
        }
    }

    function nas_open() {
        const windowElement = document.getElementById('nas-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            updateIndicator('nas-window', 'nas-indicator');
            loadLogs();
        }
    }

    function settings_open() {
        const windowElement = document.getElementById('settings-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            updateIndicator('settings-window', 'settings-indicator');
        }
    }

    document.querySelectorAll('.section_title').forEach((titleElement) => {
        titleElement.addEventListener('click', () => {
            const section = titleElement.parentElement;
            section.classList.toggle('expanded');
        });
    });

    document.querySelectorAll('.custom-dropdown').forEach(dropdown => {
        const selected = dropdown.querySelector('.dropdown-selected');
        const list = dropdown.querySelector('.dropdown-list');
        const options = dropdown.querySelectorAll('.dropdown-option');
        const selectedText = dropdown.querySelector('span');

        selected.addEventListener('click', (e) => {
            e.stopPropagation();
            document.querySelectorAll('.custom-dropdown.open').forEach(d => {
                if (d !== dropdown) d.classList.remove('open');
            });
            dropdown.classList.toggle('open');
        });

        options.forEach(option => {
            option.addEventListener('click', (e) => {
                options.forEach(o => o.classList.remove('active'));
                option.classList.add('active');
                selectedText.textContent = option.textContent;
                dropdown.classList.remove('open');
            });
        });

        document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        dropdown.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                dropdown.classList.toggle('open');
                e.preventDefault();
            }
            if (e.key === 'Escape') {
                dropdown.classList.remove('open');
            }
        });
    });

    document.documentElement.style.transition = "background-image 0.4s ease";

    let bgFadeOverlay = document.getElementById('bg-fade-overlay');
    if (!bgFadeOverlay) {
        bgFadeOverlay = document.createElement('div');
        bgFadeOverlay.id = 'bg-fade-overlay';
        document.body.prepend(bgFadeOverlay);
    }
    bgFadeOverlay.style.zIndex = '0';

    document.querySelectorAll('.background-thumb').forEach(thumb => {
        thumb.addEventListener('click', function() {
            if (this.classList.contains('selected')) return;
            document.querySelectorAll('.background-thumb').forEach(t => t.classList.remove('selected'));
            this.classList.add('selected');

            const html = document.documentElement;
            let bgPath = this.dataset.bg;
            if (!bgPath.startsWith('web/')) {
                bgPath = 'web/' + bgPath;
            }
            const newBg = `url('${bgPath}')`;

            bgFadeOverlay.style.backgroundImage = newBg;
            bgFadeOverlay.style.opacity = '0';
            bgFadeOverlay.style.transition = 'none';
            bgFadeOverlay.style.zIndex = '0';
            void bgFadeOverlay.offsetWidth;
            bgFadeOverlay.style.transition = 'opacity 0.4s cubic-bezier(0.4,0,0.2,1)';
            bgFadeOverlay.style.opacity = '1';

            setTimeout(() => {
                html.style.backgroundImage = newBg;
                bgFadeOverlay.style.opacity = '0';
            }, 400);
        });
    });

    function updateClock() {
        const clock = document.getElementById('clock');
        if (!clock) return;
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        clock.textContent = `${hours}:${minutes}`;
    }
    updateClock();
    setInterval(updateClock, 1000);

    document.querySelectorAll('.accept_btn, .update_btn').forEach(btn => {
        btn.addEventListener('click', async function () {
            this.classList.remove('active');
            void this.offsetWidth;
            this.classList.add('active');
            setTimeout(() => {
                this.classList.remove('active');
            }, 450);

            if (this.id === 'personal_accept') {
                const savedDiv = document.getElementById('personal_saved');
                if (savedDiv) {
                    savedDiv.classList.add('visible');
                    clearTimeout(savedDiv._hideTimeout);
                    savedDiv._hideTimeout = setTimeout(() => {
                        savedDiv.classList.remove('visible');
                    }, 5000);
                }
            }
            if (this.id === 'server_accept') {
                const savedDiv = document.getElementById('server_saved');
                if (savedDiv) {
                    savedDiv.classList.add('visible');
                    clearTimeout(savedDiv._hideTimeout);
                    savedDiv._hideTimeout = setTimeout(() => {
                        savedDiv.classList.remove('visible');
                    }, 5000);
                }
            }
            if (this.id === 'ftp_accept') {
                const savedDiv = document.getElementById('ftp_saved');
                if (savedDiv) {
                    savedDiv.classList.add('visible');
                    clearTimeout(savedDiv._hideTimeout);
                    savedDiv._hideTimeout = setTimeout(() => {
                        savedDiv.classList.remove('visible');
                    }, 5000);
                }
            }

            if (this.classList.contains('update_btn')) {
                try {
                    await fetch(`${baseURL}/api/update`, {
                        method: 'POST',
                        headers: {
                            ...getAuthHeaders(),
                            'Content-Type': 'application/json'
                        }
                    });
                } catch (e) {
                }
                fullScreenIcon();
            }
        });
    });

    function fullScreenIcon() {
        const bodyChildren = Array.from(document.body.children);
                bodyChildren.forEach(el => {
                    if (el.id !== 'bg-fade-overlay' && el.tagName !== 'SCRIPT' && !el.classList.contains('icon')) {
                        el.classList.add('fade-out');
                    }
                });
                setTimeout(() => {
                    bodyChildren.forEach(el => {
                        if (el.id !== 'bg-fade-overlay' && el.tagName !== 'SCRIPT' && !el.classList.contains('icon')) {
                            el.style.display = 'none';
                        }
                    });
                    const icon = document.querySelector('.icon');
                    if (icon) {
                        icon.classList.remove('fade-out');
                        icon.style.display = '';
                        icon.classList.add('icon-center-animate');
                    }
                    setTimeout(() => {
                        let pollInterval = setInterval(async () => {
                            try {
                                const res = await fetch(`${baseURL}/api/is_up`);
                                if (res.ok) {
                                    clearInterval(pollInterval);
                                    location.reload();
                                }
                            } catch (e) {
                            }
                        }, 10000);
                    }, 20000);
                }, 600);
    }

    function updateIconVisibility() {
        const iconSelect = document.getElementById('icon-select');
        const icon = document.querySelector('.icon');
        if (!iconSelect || !icon) return;
        if (iconSelect.value === 'Hidden') {
            icon.classList.add('hide');
        } else {
            icon.classList.remove('hide');
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        const iconSelect = document.getElementById('icon-select');
        if (iconSelect) {
            iconSelect.addEventListener('change', updateIconVisibility);
        }
    });

    async function loadPersonalSettings() {
        const jwtToken = localStorage.getItem('jwt_token');
        if (!jwtToken) return;
        try {
            const res = await fetch(`${baseURL}/api/user/get_self`, {
                headers: getAuthHeaders()
            });
            if (!res.ok) redirectToAuth();
            const user = await res.json();

            document.getElementById('name').value = user.name || '';
            document.getElementById('username').value = user.username || '';
            document.getElementById('password_web').value = user.password || '';

            let settings = {};
            try {
                settings = JSON.parse(user.settings || '{}');
            } catch (e) {}

            if (settings.background) {
                document.querySelectorAll('.background-thumb').forEach(thumb => {
                    if (thumb.dataset.bg === settings.background.replace('web/', '')) {
                        thumb.classList.add('selected');
                        document.documentElement.style.backgroundImage = `url('web/${settings.background.replace('web/', '')}')`;
                    } else {
                        thumb.classList.remove('selected');
                    }
                });
            }

            if (settings.iconVisible !== undefined) {
                document.getElementById('icon-select').value = settings.iconVisible ? 'Visible' : 'Hidden';
            }
            
            updateIconVisibility();
        } catch (err) {
            showNotification(err, 'error');
        }
    }

    async function savePersonalSettings() {
        const jwtToken = localStorage.getItem('jwt_token');
        if (!jwtToken) return;
        const name = document.getElementById('name').value;
        const username = document.getElementById('username').value;
        const password = document.getElementById('password_web').value;
        const iconVisible = document.getElementById('icon-select').value === 'Visible';
        const selectedBg = document.querySelector('.background-thumb.selected')?.dataset.bg || '';

        const settings = {
            background: selectedBg,
            iconVisible: iconVisible
        };

        try {
            const res = await fetch(`${baseURL}/api/user/edit_self`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...getAuthHeaders()
                },
                body: JSON.stringify({
                    name,
                    username,
                    password,
                    settings: JSON.stringify(settings)
                })
            });
            if (!res.ok) throw new Error('Failed to save settings');
        } catch (err) {
            showNotification('Could not save personal settings.', 'error');
        }
    }

    let currentServerSettings = null;

    async function loadServerSettings() {
        const jwtToken = localStorage.getItem('jwt_token');
        if (!jwtToken) return;
        try {
            const res = await fetch(`${baseURL}/api/get_settings`, {
                headers: getAuthHeaders()
            });
            if (!res.ok) throw new Error('Failed to fetch server settings');
            const settings = await res.json();
            currentServerSettings = settings;

            document.getElementById('path').value = settings.path || '';
            document.getElementById('host').value = settings.host || '';
            document.getElementById('port').value = settings.port || '';

            document.getElementById('ftp-server').value = settings.ftp ? 'On' : 'Off';
            document.getElementById('ftp-ip').value = settings.ftp_host || '';
            document.getElementById('ftp-port').value = settings.ftp_port || '';
            document.getElementById('ftp-timeout').value = settings.ftp_timeout || '';

            const currentVersionLabel = document.getElementById('current_version');
            const versionDiv = document.getElementById('version');
            const newestVersionLabel = document.getElementById('newest_version');
            const versionDescription = document.getElementById('version_description');
            if (currentVersionLabel) {
                currentVersionLabel.textContent = "Current version: " + (settings.version || "unknown");
            }
            try {
                const [newestVersionRes, descRes] = await Promise.all([
                    fetch("https://raw.githubusercontent.com/bbarni2020/Shareify/refs/heads/main/info/version"),
                    fetch("https://raw.githubusercontent.com/bbarni2020/Shareify/refs/heads/main/info/version_dsc")
                ]);
                const newestVersion = (await newestVersionRes.text()).trim();
                const versionDsc = (await descRes.text()).trim();
                if ((settings.version || "").trim() !== newestVersion) {
                    if (versionDiv) versionDiv.style.display = "";
                    if (newestVersionLabel) newestVersionLabel.textContent = "Newest: " + newestVersion;
                    if (versionDescription) versionDescription.textContent = "Description: " + versionDsc;
                } else {
                    if (versionDiv) versionDiv.style.display = "none";
                    currentVersionLabel.textContent = "Current version: " + (settings.version || "unknown") + " (latest)";
                }
            } catch (e) {
                if (versionDiv) versionDiv.style.display = "none";
            }
        } catch (err) {}
    }

    function gatherServerSettingsFromFields() {
        return {
            ftp: document.getElementById('ftp-server').value === 'On',
            ftp_host: document.getElementById('ftp-ip').value,
            ftp_port: parseInt(document.getElementById('ftp-port').value, 10) || 0,
            ftp_timeout: parseInt(document.getElementById('ftp-timeout').value, 10) || 0,
            host: document.getElementById('host').value,
            path: document.getElementById('path').value,
            port: parseInt(document.getElementById('port').value, 10) || 0,
            version: currentServerSettings?.version || ''
        };
    }

    async function saveServerSettings() {
        const jwtToken = localStorage.getItem('jwt_token');
        if (!jwtToken) return;
        const settings = gatherServerSettingsFromFields();
        try {
            const res = await fetch(`${baseURL}/api/update_settings`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...getAuthHeaders()
                },
                body: JSON.stringify(settings)
            });
            if (!res.ok) throw new Error('Failed to update server settings');
            currentServerSettings = settings;
        } catch (err) {
            showNotification('Could not save server settings.', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', loadServerSettings);

    document.getElementById('server_accept').addEventListener('click', saveServerSettings);
    document.getElementById('ftp_accept').addEventListener('click', saveServerSettings);

    document.addEventListener('DOMContentLoaded', loadPersonalSettings);

    document.getElementById('personal_accept').addEventListener('click', savePersonalSettings);

    document.querySelectorAll('.background-thumb').forEach(thumb => {
        thumb.addEventListener('click', savePersonalSettings);
    });
    document.getElementById('icon-select').addEventListener('change', savePersonalSettings);

    document.getElementById('leave').addEventListener('click', () => {
        
        document.documentElement.style.backgroundImage = "url('web/assets/backgrounds/back1.png')";
        const bgFadeOverlay = document.getElementById('bg-fade-overlay');
        if (bgFadeOverlay) {
            bgFadeOverlay.style.backgroundImage = "url('web/assets/backgrounds/back1.png')";
            bgFadeOverlay.style.opacity = '0';
        }
    
        const bodyChildren = Array.from(document.body.children);
        bodyChildren.forEach(el => {
            if (el.id !== 'bg-fade-overlay' && el.tagName !== 'SCRIPT') {
                el.classList.add('logout-fade-out');
            }
        });
        setTimeout(() => {
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('jwt_expiry');
            location.reload();
        }, 600);
    });

    let nasPollingInterval = null;

    function startNasPolling() {
        if (nasPollingInterval) return;
        nasPollingInterval = setInterval(async () => {
            if (!document.getElementById('nas-window').classList.contains('show')) {
                clearInterval(nasPollingInterval);
                nasPollingInterval = null;
                return;
            }
            try {
                const [cpuRes, memRes, diskRes] = await Promise.all([
                    fetch(`${baseURL}/api/stats/cpu`, { headers: getAuthHeaders() }),
                    fetch(`${baseURL}/api/stats/memory`, { headers: getAuthHeaders() }),
                    fetch(`${baseURL}/api/stats/disk`, { headers: getAuthHeaders() })
                ]);

                if (!cpuRes.ok || !memRes.ok || !diskRes.ok) throw new Error('Failed to fetch NAS stats');

                const cpuData = await cpuRes.json();
                const memoryData = await memRes.json();
                const diskData = await diskRes.json();

                updateMeter('cpu-meter', cpuData.value);
                updateMeter('memory-meter', memoryData.value);
                updateMeter('disk-meter', diskData.value);
            } catch (err) {
                console.error(err);
            }
        }, 5000);
    }

    function stopNasPolling() {
        clearInterval(nasPollingInterval);
        nasPollingInterval = null;
    }

    const meterLastPercent = {
        "cpu-meter": 0,
        "memory-meter": 0,
        "disk-meter": 0
    };

    function animateMeter(svgId, fromPercent, toPercent, colorClass, duration = 600) {
        const start = performance.now();
        function animate(now) {
            const elapsed = now - start;
            const t = Math.min(elapsed / duration, 1);
            const ease = t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
            const current = fromPercent + (toPercent - fromPercent) * ease;
            drawMeter(svgId, current, colorClass);
            if (t < 1) {
                requestAnimationFrame(animate);
            } else {
                drawMeter(svgId, toPercent, colorClass);
                meterLastPercent[svgId] = toPercent;
            }
        }
        requestAnimationFrame(animate);
    }

    function updateMeter(meterId, value) {
        const svg = document.getElementById(meterId);
        if (!svg) return;

        const radius = 50;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (value / 100) * circumference;

        svg.innerHTML = `
            <circle cx="60" cy="60" r="${radius}" stroke="#e6e6e6" stroke-width="10" fill="none"/>
            <circle cx="60" cy="60" r="${radius}" stroke="#4caf50" stroke-width="10" fill="none" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"/>
        `;
    }

    function drawMeter(svgId, percent, colorClass) {
        const svg = document.getElementById(svgId);
        if (!svg) return;
        const size = 120;
        const radius = 48;
        const cx = size / 2;
        const cy = size / 2 + 2;
        const circ = 2 * Math.PI * radius;
        const angleStart = -90;
        const angleEnd = 270;
        const arcLen = angleEnd - angleStart;
        const percentArc = arcLen * (percent / 100);

        const startRad = (angleStart) * Math.PI / 180;
        const endRad = (angleStart + percentArc) * Math.PI / 180;

        const x1 = cx + radius * Math.cos(startRad);
        const y1 = cy + radius * Math.sin(startRad);
        const x2 = cx + radius * Math.cos(endRad);
        const y2 = cy + radius * Math.sin(endRad);

        const largeArcFlag = percent > 50 ? 1 : 0;

        let strokeColor = "#65dc50";
        if (colorClass === "memory") strokeColor = "#3b82f6";
        if (colorClass === "disk") strokeColor = "#f59e42";

        svg.innerHTML = `
            <circle class="meter-bg" cx="${cx}" cy="${cy}" r="${radius}" style="stroke:#e5e7eb;"/>
            <path class="meter-fg ${colorClass}" d="
                M ${x1} ${y1}
                A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}
            " style="stroke:${strokeColor};stroke-width:13;fill:none;stroke-linecap:round;stroke-dasharray:${circ * (percent/100)},${circ};transition:stroke-dasharray 0.5s cubic-bezier(.4,0,.2,1);"/>
            <text x="${cx}" y="${cy+4}" class="meter-percent" dominant-baseline="middle" alignment-baseline="middle">${Math.round(percent)}%</text>
        `;
    }

    let resourceInterval = null;
    let lastResourceData = {cpu: 0, memory: 0, disk: 0};

    async function fetchAndDrawResources() {
        try {
            const res = await fetch(`${baseURL}/api/resources`, {
                headers: getAuthHeaders()
            });
            if (!res.ok) throw new Error();
            const data = await res.json();

            animateMeter('cpu-meter', meterLastPercent['cpu-meter'], data.cpu, 'cpu');
            animateMeter('memory-meter', meterLastPercent['memory-meter'], data.memory, 'memory');
            animateMeter('disk-meter', meterLastPercent['disk-meter'], data.disk, 'disk');

            lastResourceData = data;
        } catch {
            drawMeter('cpu-meter', lastResourceData.cpu || 0, 'cpu');
            drawMeter('memory-meter', lastResourceData.memory || 0, 'memory');
            drawMeter('disk-meter', lastResourceData.disk || 0, 'disk');
        }
    }

    function startResourcePolling() {
        if (resourceInterval) return;
        fetchAndDrawResources();
        resourceInterval = setInterval(fetchAndDrawResources, 5000);
    }

    function stopResourcePolling() {
        if (resourceInterval) {
            clearInterval(resourceInterval);
            resourceInterval = null;
        }
    }

    const nasWindow = document.getElementById('nas-window');
    const observer = new MutationObserver(() => {
        if (nasWindow.classList.contains('show')) {
            startResourcePolling();
        } else {
            stopResourcePolling();
        }
    });
    observer.observe(nasWindow, { attributes: true, attributeFilter: ['class'] });

    document.addEventListener('DOMContentLoaded', () => {
        const cliInput = document.getElementById('cli-input');
        const cliOutput = document.getElementById('cli-output');

        if (cliInput && cliOutput) {
            cliInput.addEventListener('keydown', async function (e) {
                if (e.key === 'Enter') {
                    const command = cliInput.value;
                    if (!command) return;
                    cliOutput.innerHTML += `<br><span style="color:#65dc50;">$</span> ${command}<br>`;
                    cliOutput.scrollTop = cliOutput.scrollHeight;
                    cliInput.value = '';
                    try {
                        const response = await fetch(`${baseURL}/api/command`, {
                            method: 'POST',
                            headers: {
                                ...getAuthHeaders(),
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ command })
                        });
                        const data = await response.json();
                        let output = (data && typeof data.output === 'string') ? data.output.trim() : '';
                        if (!output) {
                            cliOutput.innerHTML += '<span style="color:#dc2626;">[Error]</span> No such program or command.<br>';
                        } else {
                            cliOutput.innerHTML += output.replace(/</g, "&lt;").replace(/>/g, "&gt;") + '<br>';
                        }
                    } catch (err) {
                        cliOutput.innerHTML += '<span style="color="#dc2626;">[Error]</span> Could not execute command.<br>';
                    }
                    cliOutput.scrollTop = cliOutput.scrollHeight;
                }
            });
        }
    });

    async function loadLogs() {
        const logTableBody = document.getElementById('log-table-body');
        const jwtToken = localStorage.getItem('jwt_token');
        if (!logTableBody || !jwtToken) return;
        logTableBody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
        try {
            const res = await fetch(`${baseURL}/api/get_logs`, {
                headers: getAuthHeaders()
            });
            if (!res.ok) throw new Error('Failed to fetch logs');
            const logs = await res.json();
            if (!Array.isArray(logs) || logs.length === 0) {
                logTableBody.innerHTML = '<tr><td colspan="3">No logs found.</td></tr>';
                return;
            }
            logTableBody.innerHTML = '';
            logs.forEach(log => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${log.timestamp || ''}</td>
                    <td>${log.action || ''}</td>
                    <td>${log.ip || ''}</td>
                `;
                logTableBody.appendChild(tr);
            });
        } catch (err) {
            logTableBody.innerHTML = '<tr><td colspan="3">Error loading logs.</td></tr>';
        }
    }

    const logsObserver = new MutationObserver(() => {
        if (nasWindow.classList.contains('show')) {
            loadLogs();
        }
    });
    logsObserver.observe(nasWindow, { attributes: true, attributeFilter: ['class'] });

    document.addEventListener('DOMContentLoaded', () => {
        const cliInput = document.getElementById('cli-input');
        const cliOutput = document.getElementById('cli-output');

        if (cliInput && cliOutput) {
            cliInput.addEventListener('keydown', async function (e) {
                if (e.key === 'Enter') {
                    const command = cliInput.value;
                    if (!command) return;
                    cliOutput.innerHTML += `<br><span style="color:#65dc50;">$</span> ${command}<br>`;
                    cliOutput.scrollTop = cliOutput.scrollHeight;
                    cliInput.value = '';
                    try {
                        const response = await fetch(`${baseURL}/api/command`, {
                            method: 'POST',
                            headers: {
                                ...getAuthHeaders(),
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ command })
                        });
                        const data = await response.json();
                        let output = (data && typeof data.output === 'string') ? data.output.trim() : '';
                        if (!output) {
                            cliOutput.innerHTML += '<span style="color:#dc2626;">[Error]</span> No such program or command.<br>';
                        } else {
                            cliOutput.innerHTML += output.replace(/</g, "&lt;").replace(/>/g, "&gt;") + '<br>';
                        }
                    } catch (err) {
                        cliOutput.innerHTML += '<span style="color="#dc2626;">[Error]</span> Could not execute command.<br>';
                    }
                    cliOutput.scrollTop = cliOutput.scrollHeight;
                }
            });
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const fileActionButtons = document.querySelectorAll('.finder-selection-buttons .finder-action-btn');
        const selectionCountElement = document.getElementById('finder-selection-count');
        
        const pathGoBtn = document.getElementById('finder-path-go');
        if (pathGoBtn) {
            pathGoBtn.classList.add('visible');
        }
        
        document.querySelectorAll('.finder-file-manager .finder-item:not(.no-select)').forEach(item => {
            item.addEventListener('click', function(e) {
                if (!(e.ctrlKey || e.metaKey)) return;
                e.stopPropagation();
                this.classList.toggle('selected');

                const selectedItems = document.querySelectorAll('.finder-item.selected');
                const count = selectedItems.length;
                selectionCountElement.textContent = count === 1
                    ? "1 item selected"
                    : `${count} items selected`;
                selectionCountElement.classList.toggle('visible', count > 0);
                fileActionButtons.forEach(btn => {
                    if (btn.id === 'finder-rename-btn') {
                        btn.classList.toggle('visible', count === 1);
                    } else {
                        btn.classList.toggle('visible', count > 0);
                    }
                });
            });
        });
        const finderPath = document.getElementById('finder-path');
        if (finderPath) {
            finderPath.textContent = '/';
        }

        document.getElementById('finder-rename-btn').addEventListener('click', () => {
            const selectedItems = document.querySelectorAll('.finder-item.selected');
            if (selectedItems.length !== 1) return;
            
            const selectedItem = selectedItems[0];
            const isFolder = selectedItem.classList.contains('file-folder');
            const currentName = selectedItem.querySelector('.finder-label').textContent;
            const itemPath = selectedItem.dataset.path;

            const fileManager = document.querySelector('.finder-file-manager');
            const existingRenaming = fileManager.querySelector('.finder-item.renaming');
            if (existingRenaming) {
                existingRenaming.remove();
            }
            
            const renamingItem = selectedItem.cloneNode(true);
            renamingItem.classList.remove('selected');
            renamingItem.classList.add('renaming');
            
            const label = renamingItem.querySelector('.finder-label');
            label.innerHTML = `
                <input type="text" class="finder-rename-input" value="${currentName}" maxlength="100">
                <button class="finder-confirm-btn"></button>
            `;
            
            selectedItem.insertAdjacentElement('afterend', renamingItem);
            selectedItem.style.display = 'none';
            
            const input = renamingItem.querySelector('.finder-rename-input');
            const confirmBtn = renamingItem.querySelector('.finder-confirm-btn');
            
            input.focus();
            input.select();
            
            async function performRename() {
                const newName = input.value.trim();
                if (!newName || newName === currentName) {
                    renamingItem.remove();
                    selectedItem.style.display = '';
                    return;
                }
                
                const jwtToken = localStorage.getItem('jwt_token');
                const currentPath = document.getElementById('finder-path').value;
                const pathForAPI = currentPath.startsWith('/') ? currentPath.substring(1) : currentPath;
                
                try {
                    const endpoint = isFolder ? 'rename_folder' : 'rename_file';
                    const bodyKey = isFolder ? 'folder_name' : 'file_name';
                    
                    const response = await fetch(`${baseURL}/api/${endpoint}`, {
                        method: 'POST',
                        headers: {
                            ...getAuthHeaders(),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            [bodyKey]: currentName,
                            new_name: newName,
                            path: pathForAPI
                        })
                    });
                    
                    if (response.ok) {
                        renamingItem.remove();
                        selectedItem.style.display = '';
                        const cleanedPath = currentPath.startsWith('/') ? currentPath.substring(1) : currentPath;
                        loadFolderContents(cleanedPath);
                    } else {
                        const errorData = await response.json();
                        showNotification(`Failed to rename ${isFolder ? 'folder' : 'file'}: ${errorData.error || 'Unknown error'}`, 'error');
                        renamingItem.remove();
                        selectedItem.style.display = '';
                    }
                } catch (error) {
                    showNotification(`Failed to rename ${isFolder ? 'folder' : 'file'}. Please try again.`, 'error');
                    renamingItem.remove();
                    selectedItem.style.display = '';
                }
            }
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performRename();
                } else if (e.key === 'Escape') {
                    renamingItem.remove();
                    selectedItem.style.display = '';
                }
            });
            
            confirmBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                performRename();
            });
            
            const handleOutsideClick = (e) => {
                if (!renamingItem.contains(e.target)) {
                    renamingItem.remove();
                    selectedItem.style.display = '';
                    document.removeEventListener('click', handleOutsideClick);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 100);
        });
        document.getElementById('finder-move-btn').addEventListener('click', () => {
            //move logic
            alert('Move action (implement logic)');
        });
        document.getElementById('finder-dwonload-btn').addEventListener('click', async () => {
            const selectedItems = document.querySelectorAll('.finder-item.selected');
            if (selectedItems.length === 0) return;
            
            for (const item of selectedItems) {
                const itemPath = item.dataset.path;
                const isFolder = item.classList.contains('file-folder');
                
                try {
                    const response = await fetch(`${baseURL}/api/download?file_path=${encodeURIComponent(itemPath)}`, {
                        headers: getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.download = itemPath.split('/').pop() + (isFolder ? '.zip' : '');
                        downloadLink.style.display = 'none';
                        
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        
                        window.URL.revokeObjectURL(url);
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                    showNotification(`Failed to download ${itemPath.split('/').pop()}`, 'error');
                }
            }
        });
        document.getElementById('finder-delete-btn').addEventListener('click', async () => {
            const selectedItems = document.querySelectorAll('.finder-item.selected');
            if (selectedItems.length === 0) return;
            
            let successCount = 0;
            let failCount = 0;
            
            for (const item of selectedItems) {
                const itemPath = item.dataset.path;
                const isFolder = item.classList.contains('file-folder');
                
                try {
                    const endpoint = isFolder ? 'delete_folder' : 'delete_file';
                    const response = await fetch(`${baseURL}/api/${endpoint}`, {
                        method: 'POST',
                        headers: {
                            ...getAuthHeaders(),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ path: itemPath })
                    });
                    
                    if (response.ok) {
                        successCount++;
                    } else {
                        failCount++;
                        showNotification(`Failed to delete ${itemPath}`, 'error');
                    }
                } catch (error) {
                    failCount++;
                    console.error(`Error deleting ${itemPath}:`, error);
                }
            }
            
            if (successCount > 0) {
                const currentPath = document.getElementById('finder-path').value;
                const cleanedPath = currentPath.startsWith('/') ? currentPath.substring(1) : currentPath;
                loadFolderContents(cleanedPath);
            }
            
            if (failCount > 0) {
                showNotification(`Failed to delete ${failCount} item(s). ${successCount} item(s) deleted successfully.`, 'error');
            }
        });
        document.getElementById('finder-addfile-btn').addEventListener('click', () => {
            if (document.getElementById('finder-addfile-btn').classList.contains('disabled')) return;
            upload_open();
        });
        document.getElementById('finder-addfolder-btn').addEventListener('click', async () => {
            if (document.getElementById('finder-addfolder-btn').classList.contains('disabled')) return;
            const fileManager = document.querySelector('.finder-file-manager');
            
            const existingCreating = fileManager.querySelector('.finder-item.creating-folder');
            if (existingCreating) {
                existingCreating.remove();
            }
            
            const newFolderItem = document.createElement('div');
            newFolderItem.className = 'finder-item file-folder creating-folder';
            newFolderItem.innerHTML = `
                <div class="finder-icon"></div>
                <input type="text" class="finder-folder-input" placeholder="New folder" maxlength="50">
                <button class="finder-confirm-btn"></button>
            `;
            
            const backItem = fileManager.querySelector('.finder-item.no-select');
            if (backItem) {
                backItem.insertAdjacentElement('afterend', newFolderItem);
            } else {
                fileManager.insertBefore(newFolderItem, fileManager.firstChild);
            }
            
            const input = newFolderItem.querySelector('.finder-folder-input');
            const confirmBtn = newFolderItem.querySelector('.finder-confirm-btn');
            
            input.focus();
            input.select();
            
            async function createFolder() {
                const folderName = input.value.trim();
                if (!folderName) {
                    newFolderItem.remove();
                    return;
                }
                
                const currentPath = document.getElementById('finder-path').value;
                
                try {
                    const response = await fetch(`${baseURL}/api/create_folder`, {
                        method: 'POST',
                        headers: {
                            ...getAuthHeaders(),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            folder_name: folderName,
                            path: currentPath.startsWith('/') ? currentPath.substring(1) : currentPath
                        })
                    });
                    
                    if (response.ok) {
                        newFolderItem.remove();
                        const cleanedPath = currentPath.startsWith('/') ? currentPath.substring(1) : currentPath;
                        loadFolderContents(cleanedPath);
                    } else {
                        const errorData = await response.json();
                        showNotification(`Failed to create folder: ${errorData.error || 'Unknown error'}`, 'error');
                        newFolderItem.remove();
                    }
                } catch (error) {
                    console.error('Error creating folder:', error);
                    showNotification('Failed to create folder. Please try again.', 'error');
                    newFolderItem.remove();
                }
            }
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    createFolder();
                } else if (e.key === 'Escape') {
                    newFolderItem.remove();
                }
            });
            
            confirmBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                createFolder();
            });
            
            const handleOutsideClick = (e) => {
                if (!newFolderItem.contains(e.target)) {
                    newFolderItem.remove();
                    document.removeEventListener('click', handleOutsideClick);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 100);
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const finderPathInput = document.getElementById('finder-path');
        const finderPathGoBtn = document.getElementById('finder-path-go');
        
        if (finderPathInput && finderPathGoBtn) {
            finderPathGoBtn.addEventListener('click', () => {
                const path = finderPathInput.value;
                const cleanedPath = path.startsWith('/') ? path.substring(1) : path;
                loadFolderContents(cleanedPath);
            });
            
            finderPathInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const path = finderPathInput.value;
                    const cleanedPath = path.startsWith('/') ? path.substring(1) : path;
                    loadFolderContents(cleanedPath);
                }
            });
            
            finderPathInput.addEventListener('input', (e) => {
                updateCreationButtonsState(e.target.value);
            });
        }
    });

    let selectedFiles = [];

    function upload_open() {
        const windowElement = document.getElementById('upload-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            updateIndicator('upload-window', 'upload-indicator');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const uploadDropZone = document.getElementById('upload-drop-zone');
        const uploadFileInput = document.getElementById('upload-file-input');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadProgress = document.getElementById('upload-progress');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');

        if (uploadDropZone && uploadFileInput) {
            uploadDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadDropZone.classList.add('dragover');
            });

            uploadDropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadDropZone.classList.remove('dragover');
            });

            uploadDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadDropZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFileSelection(files);
            });

            uploadFileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleFileSelection(files);
            });

            uploadBtn.addEventListener('click', () => {
                if (selectedFiles.length > 0) {
                    uploadFiles();
                }
            });
        }

        function handleFileSelection(files) {
            const newFiles = Array.from(files);
            const existingFileNames = selectedFiles.map(f => f.name);
            
            newFiles.forEach(file => {
                if (!existingFileNames.includes(file.name)) {
                    selectedFiles.push(file);
                }
            });
            
            updateUploadUI();
        }

        function updateUploadUI() {
            const uploadText = document.querySelector('.upload-text');
            
            if (selectedFiles.length > 0) {
                uploadText.querySelector('h3').textContent = `${selectedFiles.length} file(s) selected`;
                uploadText.querySelector('p').textContent = 'Click upload to begin';
                uploadBtn.disabled = false;
                
                let existingList = uploadDropZone.querySelector('.upload-file-list');
                if (existingList) {
                    existingList.remove();
                }
                
                const fileList = document.createElement('div');
                fileList.className = 'upload-file-list';
                
                selectedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'upload-file-item';
                    fileItem.innerHTML = `
                        <span class="upload-file-name" title="${file.name}">${file.name}</span>
                        <span class="upload-file-remove" data-index="${index}">×</span>
                    `;
                    fileList.appendChild(fileItem);
                });
                
                uploadDropZone.appendChild(fileList);
                
                fileList.querySelectorAll('.upload-file-remove').forEach(removeBtn => {
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const index = parseInt(removeBtn.dataset.index);
                        removeFile(index);
                    });
                });
            } else {
                uploadText.querySelector('h3').textContent = 'Drop files here or click to browse';
                uploadText.querySelector('p').textContent = 'Select files to upload to the current directory';
                uploadBtn.disabled = true;
                
                const existingList = uploadDropZone.querySelector('.upload-file-list');
                if (existingList) {
                    existingList.remove();
                }
            }
        }

        function removeFile(index) {
            if (index >= 0 && index < selectedFiles.length) {
                selectedFiles.splice(index, 1);
                updateUploadUI();
            }
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return;
            
            uploadProgress.style.display = 'flex';
            uploadBtn.disabled = true;
            
            const currentPath = document.getElementById('finder-path')?.value || '/';
            let uploadedCount = 0;
            
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('path', currentPath.startsWith('/') ? currentPath.substring(1) : currentPath);
                
                try {
                    const response = await fetch(`${baseURL}/api/upload`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: formData
                    });
                    
                    if (response.ok) {
                        uploadedCount++;
                    } else {
                        showNotification(`Failed to upload ${file.name}`, 'error');
                    }
                } catch (error) {
                    console.error(`Error uploading ${file.name}:`, error);
                }
                
                const progress = ((i + 1) / selectedFiles.length) * 100;
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `${Math.round(progress)}% (${i + 1}/${selectedFiles.length})`;
            }
            setTimeout(() => {
                uploadProgress.style.display = 'none';
                progressFill.style.width = '0%';
                progressText.textContent = '0%';
                selectedFiles = [];
                updateUploadUI();
                uploadBtn.disabled = false;
                
                const finderWindow = document.getElementById('finder-window');
                if (finderWindow && finderWindow.classList.contains('show')) {
                    const currentPath = document.getElementById('finder-path')?.value || '/';
                    const cleanedPath = currentPath.startsWith('/') ? currentPath.substring(1) : currentPath;
                    loadFolderContents(cleanedPath);
                }
            }, 500);
        }
    document.addEventListener('click', async (e) => {
        const restart = document.getElementById('restart-btn');
        if (restart && e.target === restart) {
            const response = await fetch(`${baseURL}/api/restart`, {
                        method: 'POST',
                        headers: getAuthHeaders()
                    });
            fullScreenIcon();
        }
    });
    document.addEventListener('click', async (e) => {
        const shutdown = document.getElementById('shutdown-btn');
        if (shutdown && e.target === shutdown) {
            const response = await fetch(`${baseURL}/api/shutdown`, {
                        method: 'POST',
                        headers: getAuthHeaders()
                    });
            fullScreenIcon();
        }
        });
    });

    function openUserCreateWindow() {
        const windowElement = document.getElementById('user-create-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            document.getElementById('user-username').value = '';
            document.getElementById('user-password').value = '';
            document.getElementById('user-name').value = '';
            document.getElementById('user-paths').value = '';
            document.getElementById('user-paths-write').value = '';
            loadRoles();
        }
    }

    function openUserEditWindow(userData) {
        const windowElement = document.getElementById('user-edit-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            
            const usernameEl = document.getElementById('edit-user-username');
            const passwordEl = document.getElementById('edit-user-password');
            const nameEl = document.getElementById('edit-user-name');
            const pathsEl = document.getElementById('edit-user-paths');
            const writePathsEl = document.getElementById('edit-user-paths-write');
            
            if (usernameEl) usernameEl.value = userData.username || '';
            if (passwordEl) passwordEl.value = '';
            if (nameEl) nameEl.value = userData.name || '';
            if (pathsEl) pathsEl.value = userData.paths ? JSON.stringify(userData.paths) : '';
            if (writePathsEl) writePathsEl.value = userData.paths_write ? JSON.stringify(userData.paths_write) : '';
            
            const ftpEnabledEl = document.getElementById('edit-user-ftp-enabled');
            const ftpPathEl = document.getElementById('edit-user-ftp-path');
            const ftpPermissionsEl = document.getElementById('edit-user-ftp-permissions');
            
            if (ftpEnabledEl) ftpEnabledEl.value = userData.ftp_enabled ? 'true' : 'false';
            if (ftpPathEl) ftpPathEl.value = userData.ftp_path || '';
            if (ftpPermissionsEl) ftpPermissionsEl.value = userData.ftp_permissions || '';

            windowElement.dataset.userId = userData.id || '';
            
            loadConnectedFTPUsers(userData.username);
            
            loadRoles().then(async () => {
                await populateUserEndpointCheckboxes(userData.role || '');
            });
        }
    }

    async function loadConnectedFTPUsers(username) {
        try {
            const response = await fetch(`${baseURL}/api/ftp/get_users`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const allFTPUsers = await response.json();
                displayConnectedFTPUsers(allFTPUsers, username);
            }
        } catch (error) {
            console.error('Error loading connected FTP users:', error);
        }
    }

    function displayConnectedFTPUsers(ftpUsers, currentUsername) {
        const ftpUsersList = document.getElementById('edit-user-ftp-users-list');
        const emptyState = document.getElementById('ftp-users-empty');
        
        if (!ftpUsersList) return;

        ftpUsersList.innerHTML = '';

        const connectedUsers = ftpUsers.filter(ftpUser => 
            ftpUser.username.toLowerCase().includes(currentUsername.toLowerCase()) ||
            ftpUser.path?.includes(currentUsername)
        );

        if (connectedUsers.length === 0) {
            ftpUsersList.appendChild(emptyState.cloneNode(true));
        } else {
            connectedUsers.forEach(ftpUser => {
                const userItem = document.createElement('div');
                userItem.className = 'connected-ftp-user';
                userItem.innerHTML = `
                    <div class="ftp-user-info">
                        <div class="ftp-user-name">${ftpUser.username}</div>
                        <div class="ftp-user-details">Path: ${ftpUser.path || 'Default'} • Permissions: ${ftpUser.permissions}</div>
                    </div>
                    <div class="ftp-user-actions">
                        <button class="ftp-user-action-btn disconnect-ftp-btn" onclick="disconnectFTPUser('${ftpUser.username}', '${currentUsername}')">
                            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                                <path d="M8 1V15M1 8H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                `;
                ftpUsersList.appendChild(userItem);
            });
        }
    }

    async function connectFTPUserToUser() {
        const windowElement = document.getElementById('user-edit-window');
        const currentUsername = document.getElementById('edit-user-username').value;
        
        if (!currentUsername) {
            showNotification('Please save the user first before connecting FTP users', 'warning');
            return;
        }

        try {
            const response = await fetch(`${baseURL}/api/ftp/get_users`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const allFTPUsers = await response.json();
                
                if (allFTPUsers.length === 0) {
                    showNotification('No FTP users available. Create FTP users first.', 'warning');
                    return;
                }

                const ftpUsersList = allFTPUsers.map(user => user.username).join('\n');
                const selectedFTPUser = prompt(`Select an FTP user to connect:\n\n${ftpUsersList}\n\nEnter the FTP username:`);
                
                if (selectedFTPUser && allFTPUsers.some(user => user.username === selectedFTPUser)) {
                    showNotification(`FTP user "${selectedFTPUser}" connected to user "${currentUsername}"`, 'success');
                    loadConnectedFTPUsers(currentUsername);
                } else if (selectedFTPUser) {
                    showNotification('Invalid FTP username selected', 'error');
                }
            }
        } catch (error) {
            showNotification('Failed to connect FTP user', 'error');
        }
    }

    async function disconnectFTPUser(ftpUsername, username) {
        if (!confirm(`Disconnect FTP user "${ftpUsername}" from user "${username}"?`)) {
            return;
        }

        try {
            const response = await fetch(`${baseURL}/api/ftp/delete_user`, {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username: ftpUsername })
            });

            if (response.ok) {
                loadConnectedFTPUsers(username);
            } else {
                const errorData = await response.json();
                showNotification('Failed to disconnect user: ' + (errorData.error || 'Unknown error', 'error'));
            }
        } catch (error) {
            showNotification('Failed to disconnect FTP user', 'error');
        }
    }

    async function createUser() {
        const username = document.getElementById('user-username').value.trim();
        const password = document.getElementById('user-password').value;
        const name = document.getElementById('user-name').value.trim();
        
        const selectedEndpoints = [];
        const checkboxes = document.querySelectorAll('#user-endpoints-grid .endpoint-checkbox:checked');
        checkboxes.forEach(checkbox => {
            selectedEndpoints.push(checkbox.value);
        });
        
        const pathsText = document.getElementById('user-paths').value.trim();
        const writePathsText = document.getElementById('user-paths-write').value.trim();

        if (!username || !password) {
            showNotification('Username and password are required', 'info');
            return;
        }

        let paths = [];
        let writePaths = [];

        try {
            if (pathsText) {
                paths = JSON.parse(pathsText);
            }
            if (writePathsText) {
                writePaths = JSON.parse(writePathsText);
            }
        } catch (error) {
            showNotification('Invalid JSON format in paths fields', 'warning');
            return;
        }

        const baseRole = username.replace(/\s+/g, '').toLowerCase();
        let roleId = baseRole;
        let counter = 1;

        try {
            const usersResponse = await fetch(`${baseURL}/api/user/get_all`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (usersResponse.ok) {
                const existingUsers = await usersResponse.json();
                const existingRoles = existingUsers.map(user => user.role);
                
                while (existingRoles.includes(roleId)) {
                    roleId = `${baseRole}${counter}`;
                    counter++;
                }
            }

            const response = await fetch(`${baseURL}/api/user/create`, {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    name: name,
                    role: roleId,
                    paths: JSON.stringify(paths),
                    paths_write: JSON.stringify(writePaths)
                })
            });

            if (response.ok) {
                if (selectedEndpoints.length > 0) {
                    try {
                        const rolesResponse = await fetch(`${baseURL}/api/role/get`, {
                            method: 'GET',
                            headers: getAuthHeaders()
                        });
                        
                        if (rolesResponse.ok) {
                            const currentRoles = await rolesResponse.json();
                            
                            selectedEndpoints.forEach(endpoint => {
                                if (!currentRoles[endpoint]) {
                                    currentRoles[endpoint] = [];
                                }
                                if (!currentRoles[endpoint].includes(roleId)) {
                                    currentRoles[endpoint].push(roleId);
                                }
                            });
                            
                            await fetch(`${baseURL}/api/role/edit`, {
                                method: 'POST',
                                headers: {
                                    ...getAuthHeaders(),
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(currentRoles)
                            });
                        }
                    } catch (roleError) {
                        console.error('Error updating roles:', roleError);
                    }
                }
                
                const savedDiv = document.getElementById('user_saved');
                if (savedDiv) {
                    savedDiv.classList.add('visible');
                    setTimeout(() => {
                        savedDiv.classList.remove('visible');
                    }, 3000);
                }
                loadUsersData();
                setTimeout(() => {
                    document.getElementById('user-create-window').classList.remove('show');
                    document.getElementById('user-create-window').classList.add('hide');
                }, 1500);
            } else {
                const errorData = await response.json();
                showNotification(`Error creating user: ${errorData.error || 'Unknown error'}`, 'error');
            }
        } catch (error) {
            showNotification('Failed to create user. Please try again.', 'error');
        }
    }

    async function updateUser() {
        const windowElement = document.getElementById('user-edit-window');
        const userId = windowElement.dataset.userId;
        
        if (!userId) {
            showNotification('No user selected for editing', 'warning');
            return;
        }

        const username = document.getElementById('edit-user-username').value.trim();
        const password = document.getElementById('edit-user-password').value;
        const name = document.getElementById('edit-user-name').value.trim();
        
        const selectedEndpoints = [];
        const checkboxes = document.querySelectorAll('#edit-user-endpoints-grid .endpoint-checkbox:checked');
        checkboxes.forEach(checkbox => {
            selectedEndpoints.push(checkbox.value);
        });
        
        const currentUserResponse = await fetch(`${baseURL}/api/user/get_all`, {
            method: 'GET',
            headers: getAuthHeaders()
        });
        
        let currentRole = 'user';
        if (currentUserResponse.ok) {
            const users = await currentUserResponse.json();
            const currentUser = users.find(u => u.id == userId);
            if (currentUser) {
                currentRole = currentUser.role;
            }
        }
        
        const pathsText = document.getElementById('edit-user-paths').value.trim();
        const writePathsText = document.getElementById('edit-user-paths-write').value.trim();

        if (!username || !name) {
            showNotification('Username and name are required', 'info');
            return;
        }

        let paths = [];
        let writePaths = [];

        try {
            if (pathsText) {
                paths = JSON.parse(pathsText);
            }
            if (writePathsText) {
                writePaths = JSON.parse(writePathsText);
            }
        } catch (error) {
            showNotification('Invalid JSON format in paths fields', 'warning');
            return;
        }

        const updateData = {
            username: username,
            password: password || '',
            name: name,
            role: currentRole,
            paths: paths,
            paths_write: writePaths,
            id: userId
        };

        try {
            const response = await fetch(`${baseURL}/api/user/edit`, {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });

            if (response.ok) {
                if (selectedEndpoints.length > 0) {
                    try {
                        const rolesResponse = await fetch(`${baseURL}/api/role/get`, {
                            method: 'GET',
                            headers: getAuthHeaders()
                        });
                        
                        if (rolesResponse.ok) {
                            const currentRoles = await rolesResponse.json();
                            
                            Object.keys(currentRoles).forEach(endpoint => {
                                if (currentRoles[endpoint].includes(currentRole)) {
                                    const index = currentRoles[endpoint].indexOf(currentRole);
                                    currentRoles[endpoint].splice(index, 1);
                                    if (currentRoles[endpoint].length === 0) {
                                        delete currentRoles[endpoint];
                                    }
                                }
                            });
                            
                            selectedEndpoints.forEach(endpoint => {
                                if (!currentRoles[endpoint]) {
                                    currentRoles[endpoint] = [];
                                }
                                if (!currentRoles[endpoint].includes(currentRole)) {
                                    currentRoles[endpoint].push(currentRole);
                                }
                            });
                            
                            await fetch(`${baseURL}/api/role/edit`, {
                                method: 'POST',
                                headers: {
                                    ...getAuthHeaders(),
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(currentRoles)
                            });
                        }
                    } catch (roleError) {
                        console.error('Error updating roles:', roleError);
                    }
                }
                
                const savedDiv = document.getElementById('user_edit_saved');
                if (savedDiv) {
                    savedDiv.classList.add('visible');
                    setTimeout(() => {
                        savedDiv.classList.remove('visible');
                    }, 3000);
                }
                loadUsersData();
                setTimeout(() => {
                    document.getElementById('user-edit-window').classList.remove('show');
                    document.getElementById('user-edit-window').classList.add('hide');
                }, 1500);
            } else {
                const errorData = await response.json();
                showNotification(`Error updating user: ${errorData.error || 'Unknown error'}`, 'error');
            }
        } catch (error) {
            showNotification('Failed to update user. Please try again.', 'error');
        }
    }

    async function deleteUser(userId, username) {
        try {
            const currentUserResponse = await fetch(`${baseURL}/api/user/get_self`, {
                method: 'GET',
                headers: getAuthHeaders()
            });
            
            if (currentUserResponse.ok) {
                const currentUser = await currentUserResponse.json();
                if (currentUser.username === username) {
                    showNotification('You cannot delete your own account.', 'warning');
                    return;
                }
            }
        } catch (error) {
            showNotification('Unable to verify user permissions. Please try again.', 'error');
            return;
        }

        if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
            return;
        }

        try {
            const usersResponse = await fetch(`${baseURL}/api/user/get_all`, {
                method: 'GET',
                headers: getAuthHeaders()
            });
            
            let userRole = null;
            if (usersResponse.ok) {
                const users = await usersResponse.json();
                const user = users.find(u => u.username === username);
                if (user) {
                    userRole = user.role;
                }
            }

            const response = await fetch(`${baseURL}/api/user/delete`, {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username: username })
            });

            if (response.ok) {
                if (userRole && userRole !== 'admin') {
                    try {
                        const rolesResponse = await fetch(`${baseURL}/api/role/get`, {
                            method: 'GET',
                            headers: getAuthHeaders()
                        });
                        
                        if (rolesResponse.ok) {
                            const currentRoles = await rolesResponse.json();
                            
                            Object.keys(currentRoles).forEach(endpoint => {
                                if (currentRoles[endpoint].includes(userRole)) {
                                    const index = currentRoles[endpoint].indexOf(userRole);
                                    currentRoles[endpoint].splice(index, 1);
                                    if (currentRoles[endpoint].length === 0) {
                                        delete currentRoles[endpoint];
                                    }
                                }
                            });
                            
                            await fetch(`${baseURL}/api/role/edit`, {
                                method: 'POST',
                                headers: {
                                    ...getAuthHeaders(),
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(currentRoles)
                            });
                        }
                    } catch (roleError) {
                        console.error('Error updating roles:', roleError);
                    }
                }
                loadUsersData();
            } else {
                const errorData = await response.json();
                showNotification(`Error deleting user: ${errorData.error || 'Unknown error'}`, 'error');
            }
        } catch (error) {
            showNotification('Failed to delete user. Please try again.', 'error');
        }
    }

    async function loadUsersData() {
        try {
            const response = await fetch(`${baseURL}/api/user/get_all`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const users = await response.json();
                await displayUsers(users);
            } else {
                showNotification('Failed to load users data', 'error');
            }
        } catch (error) {
            console.error('Error loading users data:', error);
        }
    }

    async function displayUsers(users) {
        const usersContent = document.getElementById('users-content');
        if (!usersContent) return;

        usersContent.innerHTML = '';

        let currentUsername = null;
        try {
            const currentUserResponse = await fetch(`${baseURL}/api/user/get_self`, {
                method: 'GET',
                headers: getAuthHeaders()
            });
            
            if (currentUserResponse.ok) {
                const currentUser = await currentUserResponse.json();
                currentUsername = currentUser.username;
            }
        } catch (error) {
            console.error('Error getting current user:', error);
        }

        users.forEach(user => {
            const isCurrentUser = currentUsername === user.username;
            const userItem = document.createElement('div');
            userItem.className = 'users-list-item';
            
            const hasEditPermission = userPermissions['/api/user/edit'] === true;
            const hasDeletePermission = userPermissions['/api/user/delete'] === true;
            
            const editButton = hasEditPermission && !isCurrentUser ? `
                <button class="user-item-btn edit-user-btn" data-user='${JSON.stringify(user)}'>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M11.5 3.5L12.5 4.5L5 12H4V11L11.5 3.5Z" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                </button>
            ` : '';
            
            const deleteButton = hasDeletePermission && !isCurrentUser ? `
                <button class="user-item-btn delete-user-btn" data-user-id="${user.id}" data-username="${user.username}">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M6 2.5H10M2.5 4H13.5M12 4L11.5 12.5H4.5L4 4" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                </button>
            ` : '';
            
            const actionButtons = editButton + deleteButton;
            
            userItem.innerHTML = `
                <div class="user-info">
                    <div class="user-name">${user.name || user.username}${isCurrentUser ? ' (You)' : ''}</div>
                    <div class="user-details">${user.username} • ${user.role}</div>
                </div>
                <div class="user-actions">
                    ${actionButtons}
                </div>
            `;
            usersContent.appendChild(userItem);
        });

        document.querySelectorAll('.edit-user-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const userData = JSON.parse(btn.dataset.user);
                openUserEditWindow(userData);
            });
        });

        document.querySelectorAll('.delete-user-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const userId = btn.dataset.userId;
                const username = btn.dataset.username;
                deleteUser(userId, username);
            });
        });
    }

    async function loadFTPUsers() {
        try {
            const response = await fetch(`${baseURL}/api/ftp/get_users`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const ftpUsers = await response.json();
                displayFTPUsers(ftpUsers);
            } else {
                showNotification('Failed to load FTP users data' ,'error');
            }
        } catch (error) {
            console.error('Error loading FTP users data:', error);
        }
    }

    function displayFTPUsers(ftpUsers) {
        const ftpUsersContent = document.getElementById('ftpusers-content');
        if (!ftpUsersContent) return;

        ftpUsersContent.innerHTML = '';

        ftpUsers.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'users-list-item';
            
            const hasEditPermission = userPermissions['/api/ftp/edit_user'] === true;
            const hasDeletePermission = userPermissions['/api/ftp/delete_user'] === true;
            
            const editButton = hasEditPermission ? `
                <button class="user-item-btn edit-ftp-btn" data-ftp-user='${JSON.stringify(user)}'>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M11.013 2.5L13.5 4.987l-8 8L2 14l1.013-3.5z" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                </button>
            ` : '';
            
            const deleteButton = hasDeletePermission ? `
                <button class="user-item-btn delete-user-btn" data-ftp-user="${user.username}">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M6 2.5H10M2.5 4H13.5M12 4L11.5 12.5H4.5L4 4" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                </button>
            ` : '';
            
            userItem.innerHTML = `
                <div class="user-info">
                    <div class="user-name">${user.username}</div>
                    <div class="user-details">FTP User • ${user.status || 'Active'}</div>
                </div>
                <div class="user-actions">
                    ${editButton}
                    ${deleteButton}
                </div>
            `;
            ftpUsersContent.appendChild(userItem);
        });

        document.querySelectorAll('.edit-ftp-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const ftpUserData = JSON.parse(btn.dataset.ftpUser);
                openFTPEditWindow(ftpUserData);
            });
        });

        document.querySelectorAll('.delete-user-btn[data-ftp-user]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const username = btn.dataset.ftpUser;
                deleteFTPUser(username);
            });
        });
    }

    async function deleteFTPUser(username) {
        if (!confirm(`Are you sure you want to delete FTP user "${username}"?`)) {
            return;
        }

        try {
            const response = await fetch(`${baseURL}/api/ftp/delete_user`, {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username: username })
            });

            if (response.ok) {
                loadFTPUsers();
            } else {
                const errorData = await response.json();
                showNotification(`Error deleting FTP user: ${errorData.error || 'Unknown error'}`, 'error');
            }
        } catch (error) {
            showNotification('Failed to delete FTP user. Please try again.', 'error');
        }
    }

    function openFTPEditWindow(ftpUserData) {
        const windowElement = document.getElementById('ftp-edit-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            
            document.getElementById('ftp-edit-username').value = ftpUserData.username || '';
            document.getElementById('ftp-edit-password').value = '';
            document.getElementById('ftp-edit-path').value = ftpUserData.path || '';
            
            setPermissionsToCheckboxes('edit', ftpUserData.permissions || '');
            setupPermissionValidation('edit');
            
            windowElement.dataset.ftpUsername = ftpUserData.username || '';
        }
    }

    async function updateFTPUser() {
        const windowElement = document.getElementById('ftp-edit-window');
        const ftpUsername = windowElement.dataset.ftpUsername;
        
        if (!ftpUsername) {
            showNotification('No FTP user selected for editing', 'warning');
            return;
        }

        const password = document.getElementById('ftp-edit-password').value;
        const path = document.getElementById('ftp-edit-path').value.trim();
        const permissions = getPermissionsFromCheckboxes('edit');

        const requestBody = {
            username: ftpUsername
        };

        if (password) {
            requestBody.password = password;
        }
        if (path) {
            requestBody.path = path;
        }
        if (permissions) {
            requestBody.permissions = permissions;
        }

        try {
            const response = await fetch(`${baseURL}/api/ftp/edit_user`, {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (response.ok) {
                const savedDiv = document.getElementById('ftp_edit_saved');
                if (savedDiv) {
                    savedDiv.classList.add('visible');
                    setTimeout(() => {
                        savedDiv.classList.remove('visible');
                    }, 3000);
                }
                loadFTPUsers();
                setTimeout(() => {
                    document.getElementById('ftp-edit-window').classList.remove('show');
                    document.getElementById('ftp-edit-window').classList.add('hide');
                }, 1500);
            } else {
                const errorData = await response.json();
                showNotification(`Error updating FTP user: ${errorData.error || 'Unknown error'}`, 'error');
            }
        } catch (error) {
            showNotification('Failed to update FTP user. Please try again.', 'error');
        }
    }

    async function createRole() {
        const roleName = document.getElementById('role-name').value.trim();
        const selectedEndpoints = [];
        const checkboxes = document.querySelectorAll('#role-endpoints-grid .endpoint-checkbox:checked');
        checkboxes.forEach(checkbox => {
            selectedEndpoints.push(checkbox.value);
        });
        
        if (!roleName) {
            showNotification('Role name is required', 'info');
            return;
        }

        try {
            const response = await fetch(`${baseURL}/api/role/create`, {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    role_name: roleName,
                    endpoints: selectedEndpoints
                })
            });

            if (response.ok) {
                showNotification('Role created successfully', 'success');
                loadRoles();
                document.getElementById('role-name').value = '';
            } else {
                const errorData = await response.json();
                showNotification(`Error creating role: ${errorData.error || 'Unknown error'}`, 'error');
            }
        } catch (error) {
            console.error('Error creating role:', error);
            showNotification('Failed to create role. Please try again.', 'error');
        }
    }

    async function updateRole() {
        const windowElement = document.getElementById('role-details-window');
        const roleName = document.getElementById('role-endpoint-name').textContent;
        const endpoint = windowElement.dataset.endpoint;
        
        const selectedUsers = [];
        const userBadges = document.querySelectorAll('#role-users-list .role-user-badge');
        userBadges.forEach(badge => {
            selectedUsers.push(badge.textContent.split(' (')[0]);
        });
        
        if (!endpoint) {
            showNotification('No endpoint selected', 'warning');
            return;
        }

        try {
            const response = await fetch(`${baseURL}/api/role/edit`, {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    endpoint: endpoint,
                    role_name: roleName,
                    users: selectedUsers
                })
            });

            if (response.ok) {
                showNotification('Role updated successfully', 'success');
                loadRoles();
                const currentRoles = await loadRoles();
                if (currentRoles && currentRoles[endpoint]) {
                    openRoleDetailsWindow(endpoint, currentRoles[endpoint]);
                }
            } else {
                const errorData = await response.json();
                showNotification('Failed to update role: ' + (errorData.error || 'Unknown error', 'error'));
            }
        } catch (error) {
            showNotification('Failed to update role. Please try again.', 'error');
        }
    }

    function setupRoleUserDropdown(endpoint, allowedRoles, allUsers) {
        const addButton = document.getElementById('role-add-user-btn');
        const dropdown = document.getElementById('role-user-dropdown');
        
        const availableUsers = allUsers.filter(user => 
            !allowedRoles.includes(user.role)
        );
        
        dropdown.innerHTML = '';
        if (availableUsers.length === 0) {
            dropdown.innerHTML = '<div class="role-user-option">No users available to add</div>';
        } else {
            availableUsers.forEach(user => {
                const option = document.createElement('div');
                option.className = 'role-user-option';
                option.textContent = `${user.name || user.username} (${user.role})`;
                option.onclick = () => addUserToRole(endpoint, user.role);
                dropdown.appendChild(option);
            });
        }
        
        addButton.onclick = () => {
            dropdown.classList.toggle('show');
        };
        
        document.addEventListener('click', (e) => {
            if (!addButton.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
    }

    async function addUserToRole(endpoint, role) {
        try {
            const currentRoles = await loadRoles();
            if (!currentRoles) {
                showNotification('Failed to load current roles', 'error');
                return;
            }
            
            if (!currentRoles[endpoint]) {
                currentRoles[endpoint] = [];
            }
            
            if (!currentRoles[endpoint].includes(role)) {
                currentRoles[endpoint].push(role);
                
                const response = await fetch(`${baseURL}/api/role/edit`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentRoles)
                });

                if (response.ok) {
                    openRoleDetailsWindow(endpoint, currentRoles[endpoint]);
                } else {
                    const errorData = await response.json();
                    showNotification('Failed to add user: ' + (errorData.error || 'Unknown error', 'error'));
                }
            }
        } catch (error) {
            showNotification('Failed to add user. Please try again.', 'error');
        }
    }

    async function removeUserFromRole(endpoint, role) {
        if (role === 'admin') {
            showNotification('Cannot remove admin from endpoint access', 'warning');
            return;
        }
        
        if (!confirm(`Remove role "${role}" from endpoint "${endpoint}"?`)) {
            return;
        }
        
        try {
            const currentRoles = await loadRoles();
            if (!currentRoles) {
                showNotification('Failed to load current roles', 'error');
                return;
            }
            
            if (currentRoles[endpoint]) {
                currentRoles[endpoint] = currentRoles[endpoint].filter(r => r !== role);
                
                if (currentRoles[endpoint].length === 0) {
                    delete currentRoles[endpoint];
                }
                
                const response = await fetch(`${baseURL}/api/role/edit`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentRoles)
                });

                if (response.ok) {
                    openRoleDetailsWindow(endpoint, currentRoles[endpoint] || []);
                } else {
                    const errorData = await response.json();
                    showNotification('Failed to remove user: ' + (errorData.error || 'Unknown error', 'error'));
                }
            }
        } catch (error) {
            showNotification('Failed to remove user. Please try again.', 'error');
        }
    }

    async function updateEndpointCheckboxes(roles) {
        let endpointNames = {};
        try {
            const response = await fetch('web/endpoints.json');
            const endpoints = await response.json();
            endpointNames = endpoints;
        } catch (error) {
            console.error('Failed to load endpoints.json:', error);
        }
        
        const createGrid = document.getElementById('user-endpoints-grid');
        const editGrid = document.getElementById('edit-user-endpoints-grid');
        
        if (createGrid) {
            createGrid.innerHTML = '';
            Object.keys(roles).forEach(endpoint => {
                const endpointName = endpointNames[endpoint]?.name || endpoint;
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'endpoint-checkbox-item';
                checkboxItem.innerHTML = `
                    <input type="checkbox" class="endpoint-checkbox" id="create-${endpoint.replace(/[^a-zA-Z0-9]/g, '-')}" value="${endpoint}">
                    <label class="endpoint-label" for="create-${endpoint.replace(/[^a-zA-Z0-9]/g, '-')}">${endpointName}</label>
                `;
                createGrid.appendChild(checkboxItem);
            });
        }
        
        if (editGrid) {
            editGrid.innerHTML = '';
            Object.keys(roles).forEach(endpoint => {
                const endpointName = endpointNames[endpoint]?.name || endpoint;
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'endpoint-checkbox-item';
                checkboxItem.innerHTML = `
                    <input type="checkbox" class="endpoint-checkbox" id="edit-${endpoint.replace(/[^a-zA-Z0-9]/g, '-')}" value="${endpoint}">
                    <label class="endpoint-label" for="edit-${endpoint.replace(/[^a-zA-Z0-9]/g, '-')}">${endpointName}</label>
                `;
                editGrid.appendChild(checkboxItem);
            });
        }
    }

    async function populateUserEndpointCheckboxes(userRole) {
        const allCheckboxes = document.querySelectorAll('#edit-user-endpoints-grid .endpoint-checkbox');
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        if (userRole === 'admin') {
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        } else if (userRole) {
            try {
                const rolesResponse = await fetch(`${baseURL}/api/role/get`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (rolesResponse.ok) {
                    const roles = await rolesResponse.json();
                    
                    Object.keys(roles).forEach(endpoint => {
                        if (roles[endpoint].includes(userRole)) {
                            const checkbox = document.querySelector(`#edit-user-endpoints-grid .endpoint-checkbox[value="${endpoint}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading roles for user:', error);
            }
        }
    }

    function openFTPCreateWindow() {
        const windowElement = document.getElementById('ftp-create-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            
            document.getElementById('ftp-create-username').value = '';
            document.getElementById('ftp-create-password').value = '';
            document.getElementById('ftp-create-path').value = '';
            
            document.getElementById('ftp-create-read').checked = true;
            document.getElementById('ftp-create-write').checked = false;
            document.getElementById('ftp-create-delete').checked = false;
            
            setupPermissionValidation('create');
        }
    }

    function setupPermissionValidation(mode) {
        const readCheckbox = document.getElementById(`ftp-${mode}-read`);
        const writeCheckbox = document.getElementById(`ftp-${mode}-write`);
        const deleteCheckbox = document.getElementById(`ftp-${mode}-delete`);
        
        function validatePermissions() {
            if (writeCheckbox.checked && !readCheckbox.checked) {
                readCheckbox.checked = true;
            }
            
            if (deleteCheckbox.checked && !writeCheckbox.checked) {
                writeCheckbox.checked = true;
                readCheckbox.checked = true;
            }
        }
        
        writeCheckbox.addEventListener('change', () => {
            if (writeCheckbox.checked && !readCheckbox.checked) {
                readCheckbox.checked = true;
            }
        });
        
        deleteCheckbox.addEventListener('change', () => {
            if (deleteCheckbox.checked) {
                if (!writeCheckbox.checked) writeCheckbox.checked = true;
                if (!readCheckbox.checked) readCheckbox.checked = true;
            }
        });
        
        readCheckbox.addEventListener('change', () => {
            if (!readCheckbox.checked) {
                writeCheckbox.checked = false;
                deleteCheckbox.checked = false;
            }
        });
    }

    function getPermissionsFromCheckboxes(mode) {
        let permissions = '';
        if (document.getElementById(`ftp-${mode}-read`).checked) {
            permissions += 'elr';
        }
        if (document.getElementById(`ftp-${mode}-write`).checked) {
            permissions += 'wamfMT';
        }
        if (document.getElementById(`ftp-${mode}-delete`).checked) {
            permissions += 'd';
        }
        return permissions;
    }

    function setPermissionsToCheckboxes(mode, permissionsString) {
        const permissions = permissionsString || '';
        
        const hasRead = permissions.includes('e') || permissions.includes('l') || permissions.includes('r');
        document.getElementById(`ftp-${mode}-read`).checked = hasRead;
        
        const hasWrite = permissions.includes('w') || permissions.includes('a') || permissions.includes('m') || 
                        permissions.includes('f') || permissions.includes('M') || permissions.includes('T');
        document.getElementById(`ftp-${mode}-write`).checked = hasWrite;

        const hasDelete = permissions.includes('d');
        document.getElementById(`ftp-${mode}-delete`).checked = hasDelete;
    }

    async function createFTPUserFromWindow() {
        const username = document.getElementById('ftp-create-username').value.trim();
        const password = document.getElementById('ftp-create-password').value;
        const path = document.getElementById('ftp-create-path').value.trim();
        const permissions = getPermissionsFromCheckboxes('create');

        if (!username || !password || !permissions) {
            showNotification('Please fill in username, password, and select at least one permission.', 'info');
            return;
        }

        const requestBody = {
            username: username,
            password: password,
            permissions: permissions
        };

        if (path) {
            requestBody.path = path;
        }

        try {
            const response = await fetch(`${baseURL}/api/ftp/create_user`, {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (response.ok) {
                const savedDiv = document.getElementById('ftp_create_saved');
                if (savedDiv) {
                    savedDiv.classList.add('visible');
                    setTimeout(() => {
                        savedDiv.classList.remove('visible');
                    }, 3000);
                }
                loadFTPUsers();
                setTimeout(() => {
                    document.getElementById('ftp-create-window').classList.remove('show');
                    document.getElementById('ftp-create-window').classList.add('hide');
                }, 1500);
            } else {
                const errorData = await response.json();
                showNotification(`Error creating FTP user: ${errorData.error || 'Unknown error'}`, 'error');
            }
        } catch (error) {
            showNotification('Failed to create FTP user. Please try again.', 'error');
        }
    }
    async function loadRoles() {
        try {
            const response = await fetch(`${baseURL}/api/role/get`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const roles = await response.json();
                displayRoles(roles);
                await updateEndpointCheckboxes(roles);
                return roles;
            } else {
                showNotification('Failed to load roles', 'error');
                return null;
            }
        } catch (error) {
            console.error('Error loading roles:', error);
            return null;
        }
    }

    async function displayRoles(roles) {
        const rolesContent = document.getElementById('roles-content');
        if (!rolesContent) return;

        let endpointsInfo = {};
        try {
            const endpointsResponse = await fetch('/web/endpoints.json');
            if (endpointsResponse.ok) {
                endpointsInfo = await endpointsResponse.json();
            }
        } catch (error) {
            console.error('Error loading endpoints info:', error);
        }

        rolesContent.innerHTML = '';

        if (!roles || Object.keys(roles).length === 0) {
            rolesContent.innerHTML = '<div class="no-items">No roles configured</div>';
            return;
        }

        Object.keys(roles).forEach(endpoint => {
            const roleItem = document.createElement('div');
            roleItem.className = 'users-list-item';
            
            const endpointName = endpointsInfo[endpoint]?.name || endpoint;
            const userCount = roles[endpoint].length;
            
            roleItem.innerHTML = `
                <div class="user-info">
                    <div class="user-name">${endpointName}</div>
                    <div class="user-details">${endpoint} • ${userCount} user${userCount !== 1 ? 's' : ''}</div>
                </div>
            `;
            
            roleItem.addEventListener('click', () => {
                openRoleDetailsWindow(endpoint, roles[endpoint]);
            });
            
            rolesContent.appendChild(roleItem);
        });
    }

    async function openRoleDetailsWindow(endpoint, allowedRoles) {
        const windowElement = document.getElementById('role-details-window');
        if (!windowElement) return;
        let endpointsInfo = {};
        try {
            const endpointsResponse = await fetch('/web/endpoints.json');
            if (endpointsResponse.ok) {
                endpointsInfo = await endpointsResponse.json();
            }
        } catch (error) {
            console.error('Error loading endpoints info:', error);
        }
        let allUsers = [];
        try {
            const usersResponse = await fetch(`${baseURL}/api/user/get_all`, {
                method: 'GET',
                headers: getAuthHeaders()
            });
            if (usersResponse.ok) {
                allUsers = await usersResponse.json();
            }
        } catch (error) {
            console.error('Error loading users:', error);
        }
        const endpointInfo = endpointsInfo[endpoint] || {};
        document.getElementById('role-endpoint-name').textContent = endpointInfo.name || endpoint;
        document.getElementById('role-endpoint-method').textContent = endpointInfo.method || 'GET';
        document.getElementById('role-endpoint-description').textContent = endpointInfo.description || 'No description available';
        const authSection = document.querySelector('.role-details-auth');
        if (authSection) {
            authSection.style.display = 'none';
        }
        const usersList = document.getElementById('role-users-list');
        if (usersList) {
            usersList.innerHTML = '';
            
            if (allowedRoles && allowedRoles.length > 0) {
                const usersWithAccess = allUsers.filter(user => allowedRoles.includes(user.role));
                
                if (usersWithAccess.length > 0) {
                    usersWithAccess.forEach(user => {
                        const userItem = document.createElement('div');
                        userItem.className = 'users-list-item';
                        
                        const isAdmin = user.role === 'admin';
                        const deleteButton = !isAdmin ? `
                            <button class="user-item-btn delete-user-btn" onclick="removeUserFromRole('${endpoint}', '${user.role}')">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M4 4L12 12M12 4L4 12" stroke="currentColor" stroke-width="1.5"/>
                                </svg>
                            </button>
                        ` : '';
                        
                        userItem.innerHTML = `
                            <div class="user-info">
                                <div class="user-name">${user.name || user.username}</div>
                                <div class="user-details">${user.username} • ${user.role}</div>
                            </div>
                            <div class="user-actions">
                                ${deleteButton}
                            </div>
                        `;
                        usersList.appendChild(userItem);
                    });
                } else {
                    usersList.innerHTML = '<div class="no-users">No users have access to this endpoint</div>';
                }
            } else {
                usersList.innerHTML = '<div class="no-users">No users have access to this endpoint</div>';
            }
        }
        setupRoleUserDropdown(endpoint, allowedRoles || [], allUsers);
        windowElement.dataset.endpoint = endpoint;
        windowElement.classList.add('show');
        windowElement.classList.remove('hide');
        bringToFront(windowElement);
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('.users-ftpusers .add-btn')?.addEventListener('click', () => {
            openFTPCreateWindow();
        });

        document.querySelector('.users-ftpusers .remove-btn')?.addEventListener('click', () => {
            showNotification('Select an FTP user from the list to remove them.', 'info');
        });

        document.querySelector('.users-users .add-btn')?.addEventListener('click', () => {
            openUserCreateWindow();
        });

        document.querySelector('.users-users .remove-btn')?.addEventListener('click', () => {
            showNotification('Select a user from the list to remove them.', 'info');
        });

        document.getElementById('user_create_btn')?.addEventListener('click', () => {
            createUser();
        });

        document.getElementById('user_edit_btn')?.addEventListener('click', () => {
            updateUser();
        });

        document.getElementById('ftp_edit_btn')?.addEventListener('click', () => {
            updateFTPUser();
        });

        document.getElementById('ftp_create_btn')?.addEventListener('click', () => {
            createFTPUserFromWindow();
        });

        document.getElementById('connect-ftp-user-btn')?.addEventListener('click', () => {
            connectFTPUserToUser();
        });

    });
</script>
</html>