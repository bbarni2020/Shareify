<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shareify</title>
    <link rel="stylesheet" href="web/index.css">
    <link rel="shortcut icon" href="web/assets/icon.ico" type="image/x-icon">
</head>
<body>
    <div class="container">
        <div class="app_icons" style="background: url(web/assets/finder.png) lightgray 50% / cover no-repeat;" onclick="finder_open()">
            <div class="indicator" id="finder-indicator"></div>
        </div>
        <div class="app_icons" style="background: url(web/assets/user.png) lightgray 50% / cover no-repeat;" onclick="users_open()">
            <div class="indicator" id="users-indicator"></div>
        </div>
        <div class="app_icons" style="background: url(web/assets/nas.png) lightgray 50% / cover no-repeat;" onclick="nas_open()">
            <div class="indicator" id="nas-indicator"></div>
        </div>
        <div class="app_icons" style="background: url(web/assets/settings.png) lightgray 50% / cover no-repeat;" onclick="settings_open()">
            <div class="indicator" id="settings-indicator"></div>
        </div>
    </div>
    <div class="clock_div">
        <div id="clock" class="clock_text"></div>
        <div class="clock_img"></div>
    </div>
    <div class="leave" id="leave"></div>
    <div class="window" id="finder-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Finder</div>
        <div class="resize_handle"></div>
    </div>
    <div class="window" id="users-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Users</div>
        <div class="resize_handle"></div>
    </div>
    <div class="window" id="nas-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">NAS</div>
        <div class="sections_container">
            <div class="section_content resource-section-content">
                <div id="resource-meters">
                    <div class="resource-meter">
                        <svg id="cpu-meter" width="120" height="120"></svg>
                        <div class="meter-label">CPU</div>
                    </div>
                    <div class="resource-meter">
                        <svg id="memory-meter" width="120" height="120"></svg>
                        <div class="meter-label">Memory</div>
                    </div>
                    <div class="resource-meter">
                        <svg id="disk-meter" width="120" height="120"></svg>
                        <div class="meter-label">Disk</div>
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="section_title">
                    <p>Command line</p>
                    <div class="dropdown_icon"></div>
                </div>
                <div class="section_content">
                <div class="command-line-section">
                    <div class="command-line-output" id="cli-output">
                        Welcome to Shareify CLI!<br>
                    </div>
                    <div class="command-line-input-row">
                        <span class="command-line-prompt">$</span>
                        <input class="command-line-input" id="cli-input" type="text" autocomplete="off" placeholder="Type a command..." />
                    </div>
                </div>
                </div>
            </div>
            <div class="section">
                <div class="section_title">
                    <p>Logs</p>
                    <div class="dropdown_icon"></div>
                </div>
                <div class="section_content">
                    <div class="database-table-container">
                    <table class="database-table">
                        <thead>
                        <tr>
                            <th>Time</th>
                            <th>Action</th>
                            <th>Ip</th>
                        </tr>
                        </thead>
                        <tbody id="log-table-body">
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="resize_handle"></div>
    </div>
    <div class="window" id="settings-window">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 22 22" fill="none" class="exit_btn">
            <g filter="url(#filter0_i_19_3)">
                <circle cx="11" cy="11" r="11" fill="#DC2626"/>
            </g>
        </svg>
        <div class="window_title">Settings</div>
        <div class="sections_container">
            <div class="section">
                <div class="section_title">
                    <p>Personal settings</p>
                    <div class="dropdown_icon"></div>
                </div>
                <div class="section_content">
                    <p style="font-size: 17px;">Here you can edit your personal settings.</p>
                    <div class="horizontal-align">
                        <label for="name">Preferred name:</label>
                        <input type="text" name="name" id="name" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="username">Username:</label>
                        <input type="text" name="username" id="username" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="password_web">Password:</label>
                        <input type="text" name="password_web" id="password_web" class="textbox">
                    </div>
                    <div class="horizontal-align" style="margin-top: 10px;">
                        <div style="width: 100%;"></div>
                        <div id="personal_saved" class="saved_text">Saved</div>
                        <div class="accept_btn" id="personal_accept"><img src="web/assets/pipe.png" alt="pipe" class="centered-img"></div>
                    </div>
                    <div class="horizontal-align" style="margin-top: 10px;">
                        <label for="icon-select">Icon (in background):</label>
                        <select id="icon-select">
                            <option>Visible</option>
                            <option>Hidden</option>
                        </select>
                    </div>
                    <div style="margin-top: 18px; margin-bottom: 8px; font-size: 17px;">Choose background:</div>
                    <div class="background-selector" id="background-selector">
                        <div class="background-thumb selected" data-bg="assets/backgrounds/back1.png" style="background-image: url('web/assets/backgrounds/back1.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back2.png" style="background-image: url('web/assets/backgrounds/back2.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back3.png" style="background-image: url('web/assets/backgrounds/back3.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back4.png" style="background-image: url('web/assets/backgrounds/back4.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back5.png" style="background-image: url('web/assets/backgrounds/back5.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back6.png" style="background-image: url('web/assets/backgrounds/back6.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back7.png" style="background-image: url('web/assets/backgrounds/back7.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back8.png" style="background-image: url('web/assets/backgrounds/back8.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back9.png" style="background-image: url('web/assets/backgrounds/back9.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back10.png" style="background-image: url('web/assets/backgrounds/back10.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back11.png" style="background-image: url('web/assets/backgrounds/back11.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back12.png" style="background-image: url('web/assets/backgrounds/back12.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back13.png" style="background-image: url('web/assets/backgrounds/back13.png');"></div>
                        <div class="background-thumb" data-bg="assets/backgrounds/back14.png" style="background-image: url('web/assets/backgrounds/back14.png');"></div>
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="section_title">
                    <p>Server settings</p>
                    <div class="dropdown_icon"></div>
                </div>
                <div class="section_content">
                    <p style="font-size: 17px;">Here you can edit the server's general settings.</p>
                    <div class="horizontal-align">
                        <label for="path">Default path:</label>
                        <input type="text" name="path" id="path" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="host">Host ip:</label>
                        <input type="text" name="host" id="host" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="port">Host port:</label>
                        <input type="number" name="port" id="port" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="ftp-server">FTP server:</label>
                        <select id="ftp-server">
                            <option>On</option>
                            <option>Off</option>
                        </select>
                    </div>
                    <div class="horizontal-align" style="margin-top: 10px;">
                        <div style="width: 100%;"></div>
                        <div id="server_saved" class="saved_text">Saved</div>
                        <div class="accept_btn" id="server_accept"><img src="web/assets/pipe.png" alt="pipe" class="centered-img"></div>
                    </div>
                    <div class="horizontal-align" style="margin-top: 25px;">
                        <label id="current_version">Current version: loading...</label>
                    </div>
                    <div id="version" style="margin-top: 5px;">
                        <div class="horizontal-align">
                            <h4 id="newest_version">Newest: loading...</h2>
                            <div style="width: 90%;"></div>
                            <h5>Update</h6>
                            <div class="update_btn" id="verison"><img src="web/assets/go.png" alt="Update" class="centered-img"></div>
                        </div>
                        <h5 id="version_description">Description: loading...</h3>
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="section_title">
                    <p>FTP settings</p>
                    <div class="dropdown_icon"></div>
                </div>
                <div class="section_content">
                    <p style="font-size: 17px;">Here you can edit the server's general settings.</p>
                    <div class="horizontal-align">
                        <label for="ftp-ip">FTP server ip:</label>
                        <input type="text" name="ftp-ip" id="ftp-ip" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="ftp-port">FTP server port:</label>
                        <input type="number" name="ftp-port" id="ftp-port" class="textbox">
                    </div>
                    <div class="horizontal-align">
                        <label for="ftp-timeout">FTP timeout:</label>
                        <input type="number" name="ftp-timeout" id="ftp-timeout" class="textbox">
                    </div>
                    <div class="horizontal-align" style="margin-top: 10px;">
                        <div style="width: 100%;"></div>
                        <div id="ftp_saved" class="saved_text">Saved</div>
                        <div class="accept_btn" id="ftp_accept"><img src="web/assets/pipe.png" alt="pipe" class="centered-img"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="resize_handle"></div>
    </div>
    <div class="icon"></div>
</body>
<script>
    const windows = document.querySelectorAll('.window');
    let zIndexCounter = 1;
    let isDragging = false;
    let isResizing = false;
    let offsetX, offsetY, startWidth, startHeight;
    let activeDragWindow = null;

    function getTopmostWindow() {
        let topWindow = null;
        let topZ = -Infinity;
        windows.forEach(w => {
            const z = parseInt(w.style.zIndex) || 0;
            if (w.classList.contains('show') && z > topZ) {
                topZ = z;
                topWindow = w;
            }
        });
        return topWindow;
    }

    windows.forEach((windowElement) => {
        const exitButton = windowElement.querySelector('.exit_btn');
        const resizeHandle = windowElement.querySelector('.resize_handle');

        exitButton.addEventListener('click', () => {
            const windowId = windowElement.id;
            const indicatorId = `${windowId.split('-')[0]}-indicator`;
            windowElement.classList.add('hide');
            windowElement.classList.remove('show');
            updateIndicator(windowId, indicatorId);
        });

        windowElement.addEventListener('mousedown', (e) => {
            if (e.target === resizeHandle || e.target === exitButton) return;
            bringToFront(windowElement);
            if (getTopmostWindow() !== windowElement) return;
            isDragging = true;
            activeDragWindow = windowElement;
            offsetX = e.clientX - windowElement.offsetLeft;
            offsetY = e.clientY - windowElement.offsetTop;
            windowElement.style.cursor = 'grabbing';
        });

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            offsetX = e.clientX;
            offsetY = e.clientY;
            startWidth = windowElement.offsetWidth;
            startHeight = windowElement.offsetHeight;
            e.stopPropagation();
            bringToFront(windowElement);
        });
    });

    document.addEventListener('mousemove', (e) => {
        if (isDragging && activeDragWindow) {
            activeDragWindow.style.left = `${e.clientX - offsetX}px`;
            activeDragWindow.style.top = `${e.clientY - offsetY}px`;
        } else if (isResizing) {
            const activeWindow = document.querySelector('.window.show');
            if (activeWindow) {
                const newWidth = Math.max(startWidth + (e.clientX - offsetX), 300);
                const newHeight = Math.max(startHeight + (e.clientY - offsetY), 200);
                activeWindow.style.width = `${newWidth}px`;
                activeWindow.style.height = `${newHeight}px`;
            }
        }
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
        isResizing = false;
        activeDragWindow = null;
        document.body.style.cursor = 'default';
    });

    function bringToFront(windowElement) {
        zIndexCounter++;
        windowElement.style.zIndex = zIndexCounter;
    }

    function updateIndicator(windowId, indicatorId) {
        const windowElement = document.getElementById(windowId);
        const indicatorElement = document.getElementById(indicatorId);
        if (windowElement.classList.contains('show')) {
            indicatorElement.classList.add('active');
        } else {
            indicatorElement.classList.remove('active');
        }
    }

    function finder_open() {
        const windowElement = document.getElementById('finder-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            updateIndicator('finder-window', 'finder-indicator');
        }
    }

    function users_open() {
        const windowElement = document.getElementById('users-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            updateIndicator('users-window', 'users-indicator');
        }
    }

    function nas_open() {
        const windowElement = document.getElementById('nas-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            updateIndicator('nas-window', 'nas-indicator');
            loadLogs();
        }
    }

    function settings_open() {
        const windowElement = document.getElementById('settings-window');
        if (windowElement) {
            windowElement.classList.add('show');
            windowElement.classList.remove('hide');
            bringToFront(windowElement);
            updateIndicator('settings-window', 'settings-indicator');
        }
    }

    document.querySelectorAll('.section_title').forEach((titleElement) => {
        titleElement.addEventListener('click', () => {
            const section = titleElement.parentElement;
            section.classList.toggle('expanded');
        });
    });

    document.querySelectorAll('.custom-dropdown').forEach(dropdown => {
        const selected = dropdown.querySelector('.dropdown-selected');
        const list = dropdown.querySelector('.dropdown-list');
        const options = dropdown.querySelectorAll('.dropdown-option');
        const selectedText = dropdown.querySelector('span');

        selected.addEventListener('click', (e) => {
            e.stopPropagation();
            document.querySelectorAll('.custom-dropdown.open').forEach(d => {
                if (d !== dropdown) d.classList.remove('open');
            });
            dropdown.classList.toggle('open');
        });

        options.forEach(option => {
            option.addEventListener('click', (e) => {
                options.forEach(o => o.classList.remove('active'));
                option.classList.add('active');
                selectedText.textContent = option.textContent;
                dropdown.classList.remove('open');
            });
        });

        document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        dropdown.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                dropdown.classList.toggle('open');
                e.preventDefault();
            }
            if (e.key === 'Escape') {
                dropdown.classList.remove('open');
            }
        });
    });

    document.documentElement.style.transition = "background-image 0.4s ease";

    let bgFadeOverlay = document.createElement('div');
    bgFadeOverlay.id = 'bg-fade-overlay';
    bgFadeOverlay.style.position = 'fixed';
    bgFadeOverlay.style.top = 0;
    bgFadeOverlay.style.left = 0;
    bgFadeOverlay.style.width = '100vw';
    bgFadeOverlay.style.height = '100vh';
    bgFadeOverlay.style.zIndex = '-1';
    bgFadeOverlay.style.pointerEvents = 'none';
    bgFadeOverlay.style.opacity = '0';
    bgFadeOverlay.style.transition = 'opacity 0.4s ease';
    bgFadeOverlay.style.backgroundSize = 'cover';
    bgFadeOverlay.style.backgroundPosition = 'center center';
    bgFadeOverlay.style.backgroundRepeat = 'no-repeat';
    document.body.prepend(bgFadeOverlay);

    document.querySelectorAll('.background-thumb').forEach(thumb => {
        thumb.addEventListener('click', function() {
            if (this.classList.contains('selected')) return;
            document.querySelectorAll('.background-thumb').forEach(t => t.classList.remove('selected'));
            this.classList.add('selected');

            const html = document.documentElement;
            let bgPath = this.dataset.bg;
            if (!bgPath.startsWith('web/')) {
                bgPath = 'web/' + bgPath;
            }
            const newBg = `url('${bgPath}')`;

            bgFadeOverlay.style.backgroundImage = newBg;
            bgFadeOverlay.style.opacity = '0';
            void bgFadeOverlay.offsetWidth;
            bgFadeOverlay.style.opacity = '1';

            setTimeout(() => {
                html.style.backgroundImage = newBg;
                bgFadeOverlay.style.opacity = '0';
            }, 400);
        });
    });

    function updateClock() {
        const clock = document.getElementById('clock');
        if (!clock) return;
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        clock.textContent = `${hours}:${minutes}`;
    }
    updateClock();
    setInterval(updateClock, 1000);

    document.querySelectorAll('.accept_btn, .update_btn').forEach(btn => {
        btn.addEventListener('click', async function () {
            this.classList.remove('active');
            void this.offsetWidth;
            this.classList.add('active');
            setTimeout(() => {
                this.classList.remove('active');
            }, 450);

            if (this.id === 'personal_accept') {
                const savedDiv = document.getElementById('personal_saved');
                if (savedDiv) {
                    savedDiv.classList.add('visible');
                    clearTimeout(savedDiv._hideTimeout);
                    savedDiv._hideTimeout = setTimeout(() => {
                        savedDiv.classList.remove('visible');
                    }, 5000);
                }
            }
            if (this.id === 'server_accept') {
                const savedDiv = document.getElementById('server_saved');
                if (savedDiv) {
                    savedDiv.classList.add('visible');
                    clearTimeout(savedDiv._hideTimeout);
                    savedDiv._hideTimeout = setTimeout(() => {
                        savedDiv.classList.remove('visible');
                    }, 5000);
                }
            }
            if (this.id === 'ftp_accept') {
                const savedDiv = document.getElementById('ftp_saved');
                if (savedDiv) {
                    savedDiv.classList.add('visible');
                    clearTimeout(savedDiv._hideTimeout);
                    savedDiv._hideTimeout = setTimeout(() => {
                        savedDiv.classList.remove('visible');
                    }, 5000);
                }
            }

            if (this.classList.contains('update_btn')) {
                try {
                    await fetch('http://localhost:6969/api/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-KEY': apiKey
                        }
                    });
                } catch (e) {
                }
                const bodyChildren = Array.from(document.body.children);
                bodyChildren.forEach(el => {
                    if (el.id !== 'bg-fade-overlay' && el.tagName !== 'SCRIPT' && !el.classList.contains('icon')) {
                        el.classList.add('fade-out');
                    }
                });
                setTimeout(() => {
                    bodyChildren.forEach(el => {
                        if (el.id !== 'bg-fade-overlay' && el.tagName !== 'SCRIPT' && !el.classList.contains('icon')) {
                            el.style.display = 'none';
                        }
                    });
                    const icon = document.querySelector('.icon');
                    if (icon) {
                        icon.classList.remove('fade-out');
                        icon.style.display = '';
                        icon.classList.add('icon-center-animate');
                    }
                    setTimeout(() => {
                        let pollInterval = setInterval(async () => {
                            try {
                                const res = await fetch('http://localhost:6969/api/is_up');
                                if (res.ok) {
                                    clearInterval(pollInterval);
                                    location.reload();
                                }
                            } catch (e) {
                            }
                        }, 10000);
                    }, 20000);
                }, 600);
            }
        });
    });

    function updateIconVisibility() {
        const iconSelect = document.getElementById('icon-select');
        const icon = document.querySelector('.icon');
        if (!iconSelect || !icon) return;
        if (iconSelect.value === 'Hidden') {
            icon.classList.add('hide');
        } else {
            icon.classList.remove('hide');
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        const iconSelect = document.getElementById('icon-select');
        if (iconSelect) {
            iconSelect.addEventListener('change', updateIconVisibility);
            updateIconVisibility();
        }
    });

    let apiKey = localStorage.getItem('api_key');
    if (!apiKey) {
        apiKey = prompt("Please enter your API key:");
        if (apiKey) {
            localStorage.setItem('api_key', apiKey);
            const expiry = Date.now() + 60 * 60 * 10000;
            localStorage.setItem('api_key_expiry', expiry);
        }
    }
    const apiKeyExpiry = localStorage.getItem('api_key_expiry');
    if (apiKeyExpiry && Date.now() > parseInt(apiKeyExpiry, 10)) {
        localStorage.removeItem('api_key');
        localStorage.removeItem('api_key_expiry');
        location.reload();
    }

    async function loadPersonalSettings() {
        if (!apiKey) return;
        try {
            const res = await fetch('http://localhost:6969/api/user/get_self', {
                headers: { 'X-API-KEY': apiKey }
            });
            if (!res.ok) throw new Error('Failed to fetch user data');
            const user = await res.json();

            document.getElementById('name').value = user.name || '';
            document.getElementById('username').value = user.username || '';
            document.getElementById('password_web').value = user.password || '';

            let settings = {};
            try {
                settings = JSON.parse(user.settings || '{}');
            } catch (e) {}

            if (settings.background) {
                document.querySelectorAll('.background-thumb').forEach(thumb => {
                    if (thumb.dataset.bg === settings.background.replace('web/', '')) {
                        thumb.classList.add('selected');
                        document.documentElement.style.backgroundImage = `url('web/${settings.background.replace('web/', '')}')`;
                    } else {
                        thumb.classList.remove('selected');
                    }
                });
            }

            if (settings.iconVisible !== undefined) {
                document.getElementById('icon-select').value = settings.iconVisible ? 'Visible' : 'Hidden';
                updateIconVisibility();
            }
        } catch (err) {
            alert(err);
        }
    }

    async function savePersonalSettings() {
        if (!apiKey) return;
        const name = document.getElementById('name').value;
        const username = document.getElementById('username').value;
        const password = document.getElementById('password_web').value;
        const iconVisible = document.getElementById('icon-select').value === 'Visible';
        const selectedBg = document.querySelector('.background-thumb.selected')?.dataset.bg || '';

        const settings = {
            background: selectedBg,
            iconVisible: iconVisible
        };

        try {
            const res = await fetch('http://localhost:6969/api/user/edit_self', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-KEY': apiKey,
                },
                body: JSON.stringify({
                    name,
                    username,
                    password,
                    settings: JSON.stringify(settings)
                })
            });
            if (!res.ok) throw new Error('Failed to save settings');
        } catch (err) {
            alert('Could not save personal settings.');
        }
    }

    let currentServerSettings = null;

    async function loadServerSettings() {
        if (!apiKey) return;
        try {
            const res = await fetch('http://localhost:6969/api/get_settings', {
                headers: { 'X-API-KEY': apiKey }
            });
            if (!res.ok) throw new Error('Failed to fetch server settings');
            const settings = await res.json();
            currentServerSettings = settings;

            document.getElementById('path').value = settings.path || '';
            document.getElementById('host').value = settings.host || '';
            document.getElementById('port').value = settings.port || '';

            document.getElementById('ftp-server').value = settings.ftp ? 'On' : 'Off';
            document.getElementById('ftp-ip').value = settings.ftp_host || '';
            document.getElementById('ftp-port').value = settings.ftp_port || '';
            document.getElementById('ftp-timeout').value = settings.ftp_timeout || '';

            const currentVersionLabel = document.getElementById('current_version');
            const versionDiv = document.getElementById('version');
            const newestVersionLabel = document.getElementById('newest_version');
            const versionDescription = document.getElementById('version_description');
            if (currentVersionLabel) {
                currentVersionLabel.textContent = "Current version: " + (settings.version || "unknown");
            }
            try {
                const [newestVersionRes, descRes] = await Promise.all([
                    fetch("https://raw.githubusercontent.com/bbarni2020/Shareify/refs/heads/main/info/version"),
                    fetch("https://raw.githubusercontent.com/bbarni2020/Shareify/refs/heads/main/info/version_dsc")
                ]);
                const newestVersion = (await newestVersionRes.text()).trim();
                const versionDsc = (await descRes.text()).trim();
                if ((settings.version || "").trim() !== newestVersion) {
                    if (versionDiv) versionDiv.style.display = "";
                    if (newestVersionLabel) newestVersionLabel.textContent = "Newest: " + newestVersion;
                    if (versionDescription) versionDescription.textContent = "Description: " + versionDsc;
                } else {
                    if (versionDiv) versionDiv.style.display = "none";
                    currentVersionLabel.textContent = "Current version: " + (settings.version || "unknown") + " (latest)";
                }
            } catch (e) {
                if (versionDiv) versionDiv.style.display = "none";
            }
        } catch (err) {
            alert('Could not load server settings.');
        }
    }

    function gatherServerSettingsFromFields() {
        return {
            ftp: document.getElementById('ftp-server').value === 'On',
            ftp_host: document.getElementById('ftp-ip').value,
            ftp_port: parseInt(document.getElementById('ftp-port').value, 10) || 0,
            ftp_timeout: parseInt(document.getElementById('ftp-timeout').value, 10) || 0,
            host: document.getElementById('host').value,
            path: document.getElementById('path').value,
            port: parseInt(document.getElementById('port').value, 10) || 0,
            version: currentServerSettings?.version || ''
        };
    }

    async function saveServerSettings() {
        if (!apiKey) return;
        const settings = gatherServerSettingsFromFields();
        try {
            const res = await fetch('http://localhost:6969/api/update_settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-KEY': apiKey
                },
                body: JSON.stringify(settings)
            });
            if (!res.ok) throw new Error('Failed to update server settings');
            currentServerSettings = settings;
        } catch (err) {
            alert('Could not save server settings.');
        }
    }

    document.addEventListener('DOMContentLoaded', loadServerSettings);

    document.getElementById('server_accept').addEventListener('click', saveServerSettings);
    document.getElementById('ftp_accept').addEventListener('click', saveServerSettings);

    document.addEventListener('DOMContentLoaded', loadPersonalSettings);

    document.getElementById('personal_accept').addEventListener('click', savePersonalSettings);

    document.querySelectorAll('.background-thumb').forEach(thumb => {
        thumb.addEventListener('click', savePersonalSettings);
    });
    document.getElementById('icon-select').addEventListener('change', savePersonalSettings);

    document.getElementById('leave').addEventListener('click', () => {
        localStorage.removeItem('api_key');
        localStorage.removeItem('api_key_expiry');
        location.reload();
    });

    let nasPollingInterval = null;

    function startNasPolling() {
        if (nasPollingInterval) return;
        nasPollingInterval = setInterval(async () => {
            if (!document.getElementById('nas-window').classList.contains('show')) {
                clearInterval(nasPollingInterval);
                nasPollingInterval = null;
                return;
            }
            try {
                const [cpuRes, memRes, diskRes] = await Promise.all([
                    fetch('http://localhost:6969/api/stats/cpu', { headers: { 'X-API-KEY': apiKey } }),
                    fetch('http://localhost:6969/api/stats/memory', { headers: { 'X-API-KEY': apiKey } }),
                    fetch('http://localhost:6969/api/stats/disk', { headers: { 'X-API-KEY': apiKey } })
                ]);

                if (!cpuRes.ok || !memRes.ok || !diskRes.ok) throw new Error('Failed to fetch NAS stats');

                const cpuData = await cpuRes.json();
                const memoryData = await memRes.json();
                const diskData = await diskRes.json();

                updateMeter('cpu-meter', cpuData.value);
                updateMeter('memory-meter', memoryData.value);
                updateMeter('disk-meter', diskData.value);
            } catch (err) {
                console.error(err);
            }
        }, 5000);
    }

    function stopNasPolling() {
        clearInterval(nasPollingInterval);
        nasPollingInterval = null;
    }

    const meterLastPercent = {
        "cpu-meter": 0,
        "memory-meter": 0,
        "disk-meter": 0
    };

    function animateMeter(svgId, fromPercent, toPercent, colorClass, duration = 600) {
        const start = performance.now();
        function animate(now) {
            const elapsed = now - start;
            const t = Math.min(elapsed / duration, 1);
            const ease = t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
            const current = fromPercent + (toPercent - fromPercent) * ease;
            drawMeter(svgId, current, colorClass);
            if (t < 1) {
                requestAnimationFrame(animate);
            } else {
                drawMeter(svgId, toPercent, colorClass);
                meterLastPercent[svgId] = toPercent;
            }
        }
        requestAnimationFrame(animate);
    }

    function updateMeter(meterId, value) {
        const svg = document.getElementById(meterId);
        if (!svg) return;

        const radius = 50;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (value / 100) * circumference;

        svg.innerHTML = `
            <circle cx="60" cy="60" r="${radius}" stroke="#e6e6e6" stroke-width="10" fill="none"/>
            <circle cx="60" cy="60" r="${radius}" stroke="#4caf50" stroke-width="10" fill="none" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"/>
        `;
    }

    function drawMeter(svgId, percent, colorClass) {
        const svg = document.getElementById(svgId);
        if (!svg) return;
        const size = 120;
        const radius = 48;
        const cx = size / 2;
        const cy = size / 2 + 2;
        const circ = 2 * Math.PI * radius;
        const angleStart = -90;
        const angleEnd = 270;
        const arcLen = angleEnd - angleStart;
        const percentArc = arcLen * (percent / 100);

        const startRad = (angleStart) * Math.PI / 180;
        const endRad = (angleStart + percentArc) * Math.PI / 180;

        const x1 = cx + radius * Math.cos(startRad);
        const y1 = cy + radius * Math.sin(startRad);
        const x2 = cx + radius * Math.cos(endRad);
        const y2 = cy + radius * Math.sin(endRad);

        const largeArcFlag = percent > 50 ? 1 : 0;

        let strokeColor = "#65dc50";
        if (colorClass === "memory") strokeColor = "#3b82f6";
        if (colorClass === "disk") strokeColor = "#f59e42";

        svg.innerHTML = `
            <circle class="meter-bg" cx="${cx}" cy="${cy}" r="${radius}" style="stroke:#e5e7eb;"/>
            <path class="meter-fg ${colorClass}" d="
                M ${x1} ${y1}
                A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}
            " style="stroke:${strokeColor};stroke-width:13;fill:none;stroke-linecap:round;stroke-dasharray:${circ * (percent/100)},${circ};transition:stroke-dasharray 0.5s cubic-bezier(.4,0,.2,1);"/>
            <text x="${cx}" y="${cy+4}" class="meter-percent" dominant-baseline="middle" alignment-baseline="middle">${Math.round(percent)}%</text>
        `;
    }

    let resourceInterval = null;
    let lastResourceData = {cpu: 0, memory: 0, disk: 0};

    async function fetchAndDrawResources() {
        try {
            const res = await fetch('http://localhost:6969/api/resources', {
                headers: { 'X-API-KEY': apiKey }
            });
            if (!res.ok) throw new Error();
            const data = await res.json();

            animateMeter('cpu-meter', meterLastPercent['cpu-meter'], data.cpu, 'cpu');
            animateMeter('memory-meter', meterLastPercent['memory-meter'], data.memory, 'memory');
            animateMeter('disk-meter', meterLastPercent['disk-meter'], data.disk, 'disk');

            lastResourceData = data;
        } catch {
            drawMeter('cpu-meter', lastResourceData.cpu || 0, 'cpu');
            drawMeter('memory-meter', lastResourceData.memory || 0, 'memory');
            drawMeter('disk-meter', lastResourceData.disk || 0, 'disk');
        }
    }

    function startResourcePolling() {
        if (resourceInterval) return;
        fetchAndDrawResources();
        resourceInterval = setInterval(fetchAndDrawResources, 5000);
    }

    function stopResourcePolling() {
        if (resourceInterval) {
            clearInterval(resourceInterval);
            resourceInterval = null;
        }
    }

    const nasWindow = document.getElementById('nas-window');
    const observer = new MutationObserver(() => {
        if (nasWindow.classList.contains('show')) {
            startResourcePolling();
        } else {
            stopResourcePolling();
        }
    });
    observer.observe(nasWindow, { attributes: true, attributeFilter: ['class'] });

    drawMeter('cpu-meter', 0, 'cpu');
    drawMeter('memory-meter', 0, 'memory');
    drawMeter('disk-meter', 0, 'disk');
    meterLastPercent['cpu-meter'] = 0;
    meterLastPercent['memory-meter'] = 0;
    meterLastPercent['disk-meter'] = 0;

    document.addEventListener('DOMContentLoaded', () => {
        const cliInput = document.getElementById('cli-input');
        const cliOutput = document.getElementById('cli-output');

        if (cliInput && cliOutput) {
            cliInput.addEventListener('keydown', async function (e) {
                if (e.key === 'Enter') {
                    const command = cliInput.value;
                    if (!command) return;
                    cliOutput.innerHTML += `<br><span style="color:#65dc50;">$</span> ${command}<br>`;
                    cliOutput.scrollTop = cliOutput.scrollHeight;
                    cliInput.value = '';
                    try {
                        const response = await fetch('http://localhost:6969/api/command', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-API-KEY': apiKey
                            },
                            body: JSON.stringify({ command })
                        });
                        const data = await response.json();
                        let output = (data && typeof data.output === 'string') ? data.output.trim() : '';
                        if (!output) {
                            cliOutput.innerHTML += '<span style="color:#dc2626;">[Error]</span> No such program or command.<br>';
                        } else {
                            cliOutput.innerHTML += output.replace(/</g, "&lt;").replace(/>/g, "&gt;") + '<br>';
                        }
                    } catch (err) {
                        cliOutput.innerHTML += '<span style="color:#dc2626;">[Error]</span> Could not execute command.<br>';
                    }
                    cliOutput.scrollTop = cliOutput.scrollHeight;
                }
            });
        }
    });

    async function loadLogs() {
        const logTableBody = document.getElementById('log-table-body');
        if (!logTableBody || !apiKey) return;
        logTableBody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
        try {
            const res = await fetch('http://localhost:6969/api/get_logs', {
                headers: { 'X-API-KEY': apiKey }
            });
            if (!res.ok) throw new Error('Failed to fetch logs');
            const logs = await res.json();
            if (!Array.isArray(logs) || logs.length === 0) {
                logTableBody.innerHTML = '<tr><td colspan="3">No logs found.</td></tr>';
                return;
            }
            logTableBody.innerHTML = '';
            logs.forEach(log => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${log.timestamp || ''}</td>
                    <td>${log.action || ''}</td>
                    <td>${log.ip || ''}</td>
                `;
                logTableBody.appendChild(tr);
            });
        } catch (err) {
            logTableBody.innerHTML = '<tr><td colspan="3">Error loading logs.</td></tr>';
        }
    }

    const logsObserver = new MutationObserver(() => {
        if (nasWindow.classList.contains('show')) {
            loadLogs();
        }
    });
    logsObserver.observe(nasWindow, { attributes: true, attributeFilter: ['class'] });

    document.addEventListener('DOMContentLoaded', () => {
        const cliInput = document.getElementById('cli-input');
        const cliOutput = document.getElementById('cli-output');

        if (cliInput && cliOutput) {
            cliInput.addEventListener('keydown', async function (e) {
                if (e.key === 'Enter') {
                    const command = cliInput.value;
                    if (!command) return;
                    cliOutput.innerHTML += `<br><span style="color:#65dc50;">$</span> ${command}<br>`;
                    cliOutput.scrollTop = cliOutput.scrollHeight;
                    cliInput.value = '';
                    try {
                        const response = await fetch('http://localhost:6969/api/command', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-API-KEY': apiKey
                            },
                            body: JSON.stringify({ command })
                        });
                        const data = await response.json();
                        let output = (data && typeof data.output === 'string') ? data.output.trim() : '';
                        if (!output) {
                            cliOutput.innerHTML += '<span style="color:#dc2626;">[Error]</span> No such program or command.<br>';
                        } else {
                            cliOutput.innerHTML += output.replace(/</g, "&lt;").replace(/>/g, "&gt;") + '<br>';
                        }
                    } catch (err) {
                        cliOutput.innerHTML += '<span style="color:#dc2626;">[Error]</span> Could not execute command.<br>';
                    }
                    cliOutput.scrollTop = cliOutput.scrollHeight;
                }
            });
        }
    });
</script>
</html>